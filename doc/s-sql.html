<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-05-16 Sat 15:27 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>S-SQL Reference Manual</title>
<meta name="generator" content="Org mode">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">S-SQL Reference Manual</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org501d8e1">Interface</a>
<ul>
<li><a href="#org3e56749">macro sql (form)</a></li>
<li><a href="#org0ad3a22">function sql-compile (form)</a></li>
<li><a href="#orgd160a85">function sql-template (form)</a></li>
<li><a href="#org2865a4e">function enable-s-sql-syntax (&amp;optional (char #\Q))</a></li>
<li><a href="#orgb8aef99">function sql-escape-string (string)</a></li>
<li><a href="#org4f6d234">method sql-escape (value)</a></li>
<li><a href="#org549ef0e">variable <b>downcase-symbols</b></a></li>
<li><a href="#org3365b3b">variable <b>standard-sql-strings</b></a></li>
<li><a href="#org7dba828">variable <b>postgres-reserved-words</b> hashtable</a></li>
<li><a href="#orgb80156a">variable <b>escape-sql-names-p</b></a></li>
<li><a href="#orgacd9996">function sql-type-name (type)</a></li>
<li><a href="#org773a2a5">function to-sql-name (name &amp;optional (escape-p <b>escape-sql-names-p</b>)(ignore-reserved-words nil)</a></li>
<li><a href="#org4049bce">function from-sql-name (string)</a></li>
<li><a href="#org7db1958">macro register-sql-operators (arity &amp;rest names)</a></li>
</ul>
</li>
<li><a href="#orgb1b42c2">SQL Types</a>
<ul>
<li><a href="#orgced3597">type db-null</a></li>
</ul>
</li>
<li><a href="#org7a72c41">SQL Syntax</a>
<ul>
<li><a href="#org65e962b">sql-op :select (&amp;rest args)</a></li>
<li><a href="#orgc8613b6">sql-op :+, :*, :%, :&amp;, :|, :||, :and, :or, :=, :/, :!=, :&lt;, :&gt;, :&lt;=, :&gt;=, :^, :union, :union-all, :intersect, :intersect-all, :except, :except-all (&amp;rest args)</a></li>
<li><a href="#org7d6a767">sql-op :~, :not (arg)</a></li>
<li><a href="#org189aa10">sql-op :function (name (&amp;rest arg-types) return-type stability body)</a></li>
<li><a href="#org55e7372">sql-op :~, :~*, :!~, :!~* (string pattern)</a></li>
<li><a href="#org985aa3e">sql-op :like, :ilike (string pattern)</a></li>
<li><a href="#orga1bf114">sql-op :@@</a></li>
<li><a href="#org5c95fb8">sql-op :desc (column)</a></li>
<li><a href="#org50bd3ad">sql-op :nulls-first, :nulls-last (column)</a></li>
<li><a href="#org5c3fbc5">sql-op :as (form name &amp;rest fields)</a></li>
<li><a href="#org3c26ab7">sql-op :cast (query)</a></li>
<li><a href="#org574a8d2">sql-op :type (query)</a></li>
<li><a href="#org3588737">sql-op :create-composite-type (type-name &amp;rest args)</a></li>
<li><a href="#orgc773f87">sql-op :exists (query)</a></li>
<li><a href="#org2249114">sql-op :is-null (arg)</a></li>
<li><a href="#orgf2a8612">sql-op :not-null (arg)</a></li>
<li><a href="#org0cd468f">sql-op :in (value set)</a></li>
<li><a href="#org373cf09">sql-op :not-in (value set)</a></li>
<li><a href="#orgb64328b">sql-op :set (&amp;rest elements)</a></li>
<li><a href="#orgd0e4ad2">sql-op :array (query)</a></li>
<li><a href="#org57c74e1">sql-op :array[] (&amp;rest args)</a></li>
<li><a href="#org91e0ff6">sql-op :[] (form start &amp;optional end)</a></li>
<li><a href="#org9e86d82">sql-op :extract (unit form)</a></li>
<li><a href="#org9c66f32">sql-op :case (&amp;rest clauses)</a></li>
<li><a href="#org57ac1f5">sql-op :between (n start end)</a></li>
<li><a href="#org4e09b12">sql-op :between-symmetric (n start end)</a></li>
<li><a href="#orgcc5a08f">sql-op :dot (&amp;rest names)</a></li>
<li><a href="#orgae524fd">sql-op :type (form type)</a></li>
<li><a href="#org2e6bd1a">sql-op :raw (string)</a></li>
<li><a href="#org6c19170">sql-op :limit (query amount &amp;optional offset)</a></li>
<li><a href="#org5abe831">sql-op :order-by (query &amp;rest exprs)</a></li>
<li><a href="#orgb115768">sql-op :values</a></li>
<li><a href="#org194be4e">sql-op :empty-set</a></li>
<li><a href="#org7ed59e3">sql-op :group-by</a></li>
<li><a href="#org9b3333b">sql-op :grouping-sets</a></li>
</ul>
</li>
<li><a href="#org587c3a5">Time, Date and Interval Operators</a>
<ul>
<li><a href="#orgc69ded6">sql-op :interval (arg)</a></li>
<li><a href="#org5445413">sql-op :current-date ()</a></li>
<li><a href="#orgc6d6477">sql-op :current-time ()</a></li>
<li><a href="#org084c77f">sql-op :current-timestamp ()</a></li>
<li><a href="#org3157bdf">sql-op :timestamp (arg)</a></li>
<li><a href="#org3369b59">sql-op :age (&amp;rest args)</a></li>
<li><a href="#orgad83347">sql-op :date (arg)</a></li>
<li><a href="#org9613bb0">sql-op :make-interval (&amp;rest args)</a></li>
<li><a href="#orgb64e598">sql-op :make-timestamp (&amp;rest args)</a></li>
<li><a href="#org7b1b4de">sql-op :make-timestamptz (&amp;rest args)</a></li>
</ul>
</li>
<li><a href="#orgbf8712f">Aggregation Operators</a>
<ul>
<li><a href="#orgdfc4ea7">sql-op :count (&amp;rest args)</a></li>
<li><a href="#org063a112">sql-op :avg (&amp;rest rest args)</a></li>
<li><a href="#orgd433f12">sql-op :sum (&amp;rest rest args)</a></li>
<li><a href="#org38017f3">sql-op ::max (&amp;rest args)</a></li>
<li><a href="#org38666c1">sql-op ::min (&amp;rest args)</a></li>
<li><a href="#orgf54716f">sql-op ::every (&amp;rest args)</a></li>
<li><a href="#orge975bc9">sql-op :percentile-cont (&amp;rest args)</a></li>
<li><a href="#org748a418">sql-op :percentile-dist (&amp;rest args)</a></li>
<li><a href="#org1c058ab">sql-op :corr (y x)</a></li>
<li><a href="#orgd1535af">sql-op :covar-pop (y x)</a></li>
<li><a href="#org922a8ea">sql-op :covar-samp (y x)</a></li>
<li><a href="#org1581370">sql-op :string-agg (&amp;rest args)</a></li>
<li><a href="#orgfc058e4">sql-op :array-agg (&amp;rest args)</a></li>
<li><a href="#orgd2e44f7">sql-op :mode (&amp;rest args)</a></li>
<li><a href="#org5ba67f1">sql-op :regr_avgx (y x)</a></li>
<li><a href="#orgd75448f">sql-op :regr_avgy (y x)</a></li>
<li><a href="#orgd475897">sql-op :regr_count (y x)</a></li>
<li><a href="#org185748d">sql-op :regr_intercept (y x)</a></li>
<li><a href="#orgd28d0c2">sql-op :regr_r2 (y x)</a></li>
<li><a href="#org255a831">sql-op :regr_slope (y x)</a></li>
<li><a href="#org2da276e">sql-op :regr_sxx (y x)</a></li>
<li><a href="#org1a032f9">sql-op :regr_sxy (y x)</a></li>
<li><a href="#org4de2313">sql-op :regr_syy (y x)</a></li>
<li><a href="#orge3008aa">sql-op :stddev (&amp;rest args)</a></li>
<li><a href="#orgc44c19f">sql-op :stddev-pop (&amp;rest args)</a></li>
<li><a href="#orgffc6d9d">sql-op :stddev-samp (&amp;rest args)</a></li>
<li><a href="#org9f6d760">sql-op :variance (&amp;rest args)</a></li>
<li><a href="#orga3887b6">sql-op :var-pop (&amp;rest args)</a></li>
<li><a href="#org6507f83">sql-op :var-samp (&amp;rest args)</a></li>
<li><a href="#orgea55393">sql-op :over (form &amp;rest args)</a></li>
<li><a href="#orgbe7a4a4">sql-op :partition-by (&amp;rest args)</a></li>
<li><a href="#org231dcc7">sql-op :window (form)</a></li>
<li><a href="#orgc9bcb91">sql-op :with (&amp;rest args)</a></li>
<li><a href="#orgbb25245">sql-op :with-recursive (&amp;rest args)</a></li>
</ul>
</li>
<li><a href="#org2ba61ef">Table Functions</a>
<ul>
<li><a href="#org67fc5b4">sql-op :for-update (query &amp;key of nowait)</a></li>
<li><a href="#orgc58d7be">sql-op :for-share (query &amp;key of nowait)</a></li>
<li><a href="#org9c35d1b">sql-op :insert-into (table &amp;rest rest)</a></li>
<li><a href="#org84686d9">sql-op :insert-rows-into (table &amp;rest rest)</a></li>
<li><a href="#orge0ce1c8">sql-op :update (table &amp;rest rest)</a></li>
<li><a href="#org8ac39db">sql-op :delete-from (table &amp;rest rest)</a></li>
<li><a href="#org85099f7">sql-op :create-table (name (&amp;rest columns) &amp;rest options)</a>
<ul>
<li><a href="#org61479f3">Column Definition parameters</a></li>
<li><a href="#org0f04e4a">Table Constraints</a></li>
</ul>
</li>
<li><a href="#orgae5fa70">sql-op :alter-table (name action &amp;rest args)</a></li>
<li><a href="#org139f021">sql-op :drop-table (name)</a></li>
<li><a href="#orgffa30e3">sql-op :truncate (&amp;rest args)</a></li>
<li><a href="#org591caf5">sql-op :create-index (name &amp;rest args)</a></li>
<li><a href="#orgdf4af7b">sql-op :create-unique-index (name &amp;rest args)</a></li>
<li><a href="#orgc6bd0c3">sql-op :drop-index (name)</a></li>
<li><a href="#orgf27b599">sql-op :create-sequence (name &amp;key increment min-value max-value start cache cycle)</a></li>
<li><a href="#org002c30c">sql-op :alter-sequence (name)</a></li>
<li><a href="#org0f40b65">sql-op :drop-sequence (name)</a></li>
<li><a href="#org49639f7">sql-op :create-view (name query)</a></li>
<li><a href="#orgf972b50">sql-op :drop-view (name)</a></li>
<li><a href="#org7e55719">sql-op :set-constraints (state &amp;rest constraints)</a></li>
<li><a href="#org9074391">sql-op :listen (channel)</a></li>
<li><a href="#org4c9614b">sql-op :unlisten (channel)</a></li>
<li><a href="#org26de207">sql-op :notify (channel &amp;optional payload)</a></li>
<li><a href="#org5d3c774">sql-op :create-role (role &amp;rest args)</a></li>
<li><a href="#orgf8c85a3">sql-op :create-database (name)</a></li>
<li><a href="#orgcad2edd">sql-op :drop-database (name)</a></li>
<li><a href="#orgf7dd2b4">sql-op :copy (table &amp;rest args)</a></li>
</ul>
</li>
<li><a href="#dynamic-queries-composition-and-parameterized-queries">Dynamic Queries, Composition and Parameterized Queries</a>
<ul>
<li><a href="#overview">Overview</a>
<ul>
<li><a href="#programmer-built-queries">Programmer Built Queries</a></li>
<li><a href="#queries-with-user-input">Queries with User Input</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is the reference manual for the S-SQL component of the postmodern library.
</p>

<p>
S-SQL provides a lispy syntax for SQL queries, and knows how to convert various
lisp types to their textual SQL representation. It takes care to do as much of
the work as possible at compile-time, so that at runtime a string concatenation
is all that is needed to produce the final SQL query.
</p>


<div id="outline-container-org501d8e1" class="outline-2">
<h2 id="org501d8e1"><a id="ID-462ce6d8-f967-4bce-817e-d1762ebfd41f"></a>Interface</h2>
<div class="outline-text-2" id="text-org501d8e1">
</div>
<div id="outline-container-org3e56749" class="outline-3">
<h3 id="org3e56749"><a id="ID-9de76637-62f7-4c7c-a5d1-1f37491b3db3"></a>macro sql (form)</h3>
<div class="outline-text-3" id="text-org3e56749">
<p>
→ string
</p>

<p>
Convert the given form (a list starting with a keyword) to an SQL query string
at compile time, according to the rules described here. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))

 <span style="color: #cd8162;">"(SELECT * FROM country WHERE (a = 1))"</span>
</pre>
</div>

<p>
but
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql '(<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))
</pre>
</div>

<p>
would throw an error. For the later case you need to use sql-compile.
</p>
</div>
</div>

<div id="outline-container-org0ad3a22" class="outline-3">
<h3 id="org0ad3a22"><a id="ID-8d161d2a-06cb-4334-9ee6-86e805eb5295"></a>function sql-compile (form)</h3>
<div class="outline-text-3" id="text-org0ad3a22">
<p>
→ string
</p>

<p>
This is the run-time variant of the sql macro. It converts the given list to
an SQL query, with the same rules except that symbols in this list do not
have to be quoted to be interpreted as identifiers. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql-compile '(<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))

\"(SELECT * FROM country WHERE (a = 1))\"
</pre>
</div>

<p>
but
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))
</pre>
</div>

<p>
would throw an error. For the later case you need to use sql.
</p>
</div>
</div>

<div id="outline-container-orgd160a85" class="outline-3">
<h3 id="orgd160a85"><a id="ID-e16e8407-01af-4907-9ed6-2b3c1f12dd1b"></a>function sql-template (form)</h3>
<div class="outline-text-3" id="text-orgd160a85">
<p>
In cases where you do need to build the query at run time, yet you do not
want to re-compile it all the time, this function can be used to compile it
once and store the result. It takes an S-SQL form, which may contain
\[ placeholder symbols, and returns a function that takes one argument for
every \]. When called, this returned function produces an SQL string in
which the placeholders have been replaced by the values of the arguments.
</p>
</div>
</div>

<div id="outline-container-org2865a4e" class="outline-3">
<h3 id="org2865a4e"><a id="ID-bee65d01-61d4-4823-b0ab-26789642cdb3"></a>function enable-s-sql-syntax (&amp;optional (char #\Q))</h3>
<div class="outline-text-3" id="text-org2865a4e">
<p>
Modifies the current readtable to add a #Q syntax that is read as (sql &#x2026;).
The character to use can be overridden by passing an argument.
</p>
</div>
</div>
<div id="outline-container-orgb8aef99" class="outline-3">
<h3 id="orgb8aef99"><a id="ID-02edac61-f915-4d5f-b52e-d4b7ace29352"></a>function sql-escape-string (string)</h3>
<div class="outline-text-3" id="text-orgb8aef99">
<p>
→ string
</p>

<p>
<a href="http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS">Escapes</a> a string for inclusion in a PostgreSQL query. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql-escape-string \"Puss in 'Boots'\")

\"E'Puss in ''Boots'''\"

</pre>
</div>
</div>
</div>

<div id="outline-container-org4f6d234" class="outline-3">
<h3 id="org4f6d234"><a id="ID-59d7247c-c2fa-46c3-b682-dab17fac8812"></a>method sql-escape (value)</h3>
<div class="outline-text-3" id="text-org4f6d234">
<p>
→ string
</p>

<p>
A generalisation of sql-escape-string looks at the type of the value passed, and properly writes it out it for inclusion in an SQL query. Symbols will be
converted to SQL names. Examples:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql-escape <span style="color: #cd8162;">"tr'-x"</span>)

<span style="color: #cd8162;">"E'tr''-x'"</span>

(sql-escape (/ 1 13))

<span style="color: #cd8162;">"0.0769230769230769230769230769230769230"</span>

(sql-escape #(<span style="color: #cd8162;">"Baden-Wurttemberg"</span> <span style="color: #cd8162;">"Bavaria"</span> <span style="color: #cd8162;">"Berlin"</span> <span style="color: #cd8162;">"Brandenburg"</span>))

<span style="color: #cd8162;">"ARRAY[E'Baden-Wurttemberg', E'Bavaria', E'Berlin', E'Brandenburg']"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org549ef0e" class="outline-3">
<h3 id="org549ef0e"><a id="ID-19c05bac-8209-4e48-b2e0-549ff03df44e"></a>variable <b>downcase-symbols</b></h3>
<div class="outline-text-3" id="text-org549ef0e">
<p>
When converting symbols to strings, whether to downcase the symbols is set here. The default is to downcase symbols.
</p>
</div>
</div>
<div id="outline-container-org3365b3b" class="outline-3">
<h3 id="org3365b3b"><a id="ID-95a70c76-0fcb-4967-88a2-3460bbcb5311"></a>variable <b>standard-sql-strings</b></h3>
<div class="outline-text-3" id="text-org3365b3b">
<p>
Used to configure whether S-SQL will use standard SQL strings (just replace #\' with ''), or backslash-style escaping. Setting this to NIL is always safe, but when the server is configured to allow standard strings (compile-time parameter 'standard_conforming_strings' is 'on', which will become the default in future versions of PostgreSQL), the noise in queries can be reduced by setting this to T.
</p>
</div>
</div>

<div id="outline-container-org7dba828" class="outline-3">
<h3 id="org7dba828"><a id="ID-a975b46b-5ade-4358-aa77-f83681299a94"></a>variable <b>postgres-reserved-words</b> hashtable</h3>
<div class="outline-text-3" id="text-org7dba828">
<p>
A set of all Postgresql's reserved words, for automatic escaping. Probably not a good idea to use these words as identifiers anyway.
 '("all" "analyse" "analyze" "and" "any" "array" "as" "asc" "asymmetric" "authorization"
   "between" "binary" "both" "case" "cast" "check" "collate" "column" "concurrently"
   "constraint" "create" "cross" "current-catalog" "current-date" "current-role" "current-schema"
   "current-time" "current-timestamp" "current-user" "default" "deferrable"
   "desc" "distinct" "do" "else" "end" "except" "false" "fetch" "filter"
   "for" "foreign" "freeze" "from" "full" "grant" "group" "having" "ilike" "in" "initially"
   "inner" "intersect" "into" "is" "isnull" "join" "lateral" "leading" "left" "like" "limit"
   "localtime" "localtimestamp" "natural" "new" "not" "notnull" "nowait" "null" "off" "offset" "old"
   "on" "only" "or" "order" "outer" "overlaps" "placing" "primary" "references" "returning"
   "right" "select" "session-user" "Share" "similar" "some" "symmetric" "table" "then" "to" "trailing" "true"
   "union" "unique" "user" "using" "variadic" "verbose" "when" "where" "window" "with"))
</p>
</div>
</div>

<div id="outline-container-orgb80156a" class="outline-3">
<h3 id="orgb80156a"><a id="ID-974ac94c-23eb-4bba-b324-d79fba034c1d"></a>variable <b>escape-sql-names-p</b></h3>
<div class="outline-text-3" id="text-orgb80156a">
<p>
Determines whether double quotes are added around column, table, and ** function names in
queries. Valid values:
</p>

<ul class="org-ul">
<li>T, in which case every name is escaped,</li>
<li>NIL, in which case no name is escape,</li>
<li>:auto, which causes only <a href="http://www.postgresql.org/docs/current/static/sql-keywords-appendix.html">reserved words</a> to be escaped, or.</li>
<li>:literal which is the same as :auto except it has added consequence in to-sql-name (see below).</li>
</ul>

<p>
The default value is :auto.
</p>

<p>
Be careful when binding this with let and such ― since a lot of SQL compilation tends to happen at
compile-time, the result might not be what you expect. Mixed case sensitivity is not currently
well supported. Postgresql itself will downcase unquoted identifiers. This will be revisited in the
future if requested.
</p>
</div>
</div>

<div id="outline-container-orgacd9996" class="outline-3">
<h3 id="orgacd9996"><a id="ID-79bc7903-3321-4e01-a0a0-819ad61179b5"></a>function sql-type-name (type)</h3>
<div class="outline-text-3" id="text-orgacd9996">
<p>
→ string
</p>

<p>
Transform a lisp type into a string containing something SQL understands. Default is to just use the type symbol's name.
</p>
</div>
</div>

<div id="outline-container-org773a2a5" class="outline-3">
<h3 id="org773a2a5"><a id="ID-46c8eab0-4fac-4b14-8193-6b93c985ad0f"></a>function to-sql-name (name &amp;optional (escape-p <b>escape-sql-names-p</b>)(ignore-reserved-words nil)</h3>
<div class="outline-text-3" id="text-org773a2a5">
<p>
→ string
</p>

<p>
Convert a symbol or string into a name that can be a sql table, column, or operation name. Add quotes when escape-p is true, or escape-p is :auto and the name contains reserved words. Quoted or delimited identifiers can be used by passing :literal as the value of escape-p. If escape-p is :literal, and the name is a string then the string is still escaped but the symbol or string is not downcased, regardless of the setting for <b>downcase-symbols</b> and the hyphen and forward slash characters are not replaced with underscores.
</p>

<p>
Ignore-reserved-words is only used internally for column names which are allowed to be reserved words, but it is not recommended.
</p>
</div>
</div>


<div id="outline-container-org4049bce" class="outline-3">
<h3 id="org4049bce"><a id="ID-5a8737c8-f850-4807-974c-8f711cc9ae1c"></a>function from-sql-name (string)</h3>
<div class="outline-text-3" id="text-org4049bce">
<p>
→ keyword
</p>

<p>
Convert a string that represents an SQL identifier to a keyword by uppercasing
it and converting the underscores to dashes.
</p>
</div>
</div>

<div id="outline-container-org7db1958" class="outline-3">
<h3 id="org7db1958"><a id="ID-594e6029-8c94-4bb6-ad36-83ab42dc6369"></a>macro register-sql-operators (arity &amp;rest names)</h3>
<div class="outline-text-3" id="text-org7db1958">
<p>
Define simple SQL operators. Arity is one of :unary (like 'not'), :unary-postfix
(the operator comes after the operand), :n-ary (like '\+': the operator falls away
when there is only one operand), :2+-ary (like '=', which is meaningless for one
operand), or :n-or-unary (like '-', where the operator is kept in the unary case).
After the arity may follow any number of operators, either just a keyword, in
which case the downcased symbol name is used as the SQL operator, or a two-element
list containing a keyword and a name string.
</p>
</div>
</div>
</div>
<div id="outline-container-orgb1b42c2" class="outline-2">
<h2 id="orgb1b42c2"><a id="ID-fd140802-2b42-49b6-b21c-c0d4adae6136"></a>SQL Types</h2>
<div class="outline-text-2" id="text-orgb1b42c2">
<p>
S-SQL knows the SQL equivalents to a number of Lisp types, and defines some
extra types that can be used to denote other SQL types. The following
table shows the correspondence:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Lisp type</th>
<th scope="col" class="org-left">SQL type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">integer</td>
<td class="org-left">smallint</td>
<td class="org-left">-32,768 to +32,768 2-byte storage</td>
</tr>

<tr>
<td class="org-left">integer</td>
<td class="org-left">integer</td>
<td class="org-left">-2147483648 to +2147483647 integer, 4-byte storage</td>
</tr>

<tr>
<td class="org-left">integer</td>
<td class="org-left">bigint</td>
<td class="org-left">-9223372036854775808 to 9223372036854775807 integer 8-byte storage</td>
</tr>

<tr>
<td class="org-left">(numeric X Y)</td>
<td class="org-left">numeric(X, Y)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">float, real</td>
<td class="org-left">real</td>
<td class="org-left">single-precision floating point number, 6 decimal digit precision 4-byte storage</td>
</tr>

<tr>
<td class="org-left">double-float</td>
<td class="org-left">double-precision</td>
<td class="org-left">double-precision floating point number, 15 decimal digit precision 8-byte storage</td>
</tr>

<tr>
<td class="org-left">string, text</td>
<td class="org-left">text</td>
<td class="org-left">variable length string, no limit specified</td>
</tr>

<tr>
<td class="org-left">string</td>
<td class="org-left">char(X)</td>
<td class="org-left">char(length), blank-padded string, fixed storage length</td>
</tr>

<tr>
<td class="org-left">string</td>
<td class="org-left">varchar(X)</td>
<td class="org-left">varchar(length), non-blank-padded string, variable storage length</td>
</tr>

<tr>
<td class="org-left">boolean</td>
<td class="org-left">boolean</td>
<td class="org-left">boolean, 'true'/'false', 1 byte</td>
</tr>

<tr>
<td class="org-left">bytea</td>
<td class="org-left">bytea</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">date</td>
<td class="org-left">date</td>
<td class="org-left">date range: 4713 BC to 5874897 AD</td>
</tr>

<tr>
<td class="org-left"><a href="interval-notes.html">interval</a></td>
<td class="org-left">interval</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">array</td>
<td class="org-left">array</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-orgced3597" class="outline-3">
<h3 id="orgced3597"><a id="ID-73bdde0f-96d9-494e-854e-f03f6197c88f"></a>type db-null</h3>
<div class="outline-text-3" id="text-orgced3597">
<p>
This is a type of which only the keyword :null is a member. It is used to represent
NULL values from the database.
</p>
</div>
</div>
</div>

<div id="outline-container-org7a72c41" class="outline-2">
<h2 id="org7a72c41"><a id="ID-13fef0a2-bbe1-44a1-9bc1-570ffdbb4093"></a>SQL Syntax</h2>
<div class="outline-text-2" id="text-org7a72c41">
<p>
An S-SQL form is converted to a query through the following rules:
</p>

<ul class="org-ul">
<li>Lists starting with a keyword are operators. They are expanded as
described below if they are known, otherwise they are expanded in the
standard way: operator(arguments, &#x2026;)</li>

<li>Quoted symbols or keywords are interpreted as names of columns or
tables, and converted to strings with to-sql-name.</li>

<li>Anything else is evaluated and the resulting Lisp value is converted
to its textual SQL representation (or an error is raised when there is
no rule for converting objects of this type). Self-quoting atoms may
be converted to strings at compile-time.</li>
</ul>
</div>

<div id="outline-container-org65e962b" class="outline-3">
<h3 id="org65e962b"><a id="ID-e8ff770d-fbce-461d-ac3b-4959bc8770c1"></a>sql-op :select (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org65e962b">
<p>
Creates a select query. The arguments are split on the keywords found among
them. The group of arguments immediately after :select is interpreted as
the expressions that should be selected. After this, an optional :distinct
may follow, which will cause the query to only select distinct rows, or
alternatively :distinct-on followed by a group of row names. Next comes the
optional keyword :from, followed by at least one table name and then any
number of join statements. Join statements start with one of :left-join,
:right-join, :inner-join, :outer-join or :cross-join, then a table name or
subquery, then the keyword :on or :using, if applicable, and then a form.
A join can be preceded by :natural (leaving off the :on clause) to use a
natural join. After the joins an optional :where followed by a single form
may occur. And finally :group-by and :having can optionally be specified.
The first takes any number of arguments, and the second only one. An example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:+</span> 'field-1 100) 'field-5
        <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'my-table 'x)
        <span style="color: #98fb98; font-weight: bold;">:left-join</span> 'your-table
        <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'x.field-2 'your-table.field-1)
        <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:not-null</span> 'a.field-3)))
</pre>
</div>

<p>
The following operators are defined:
</p>
</div>
</div>

<div id="outline-container-orgc8613b6" class="outline-3">
<h3 id="orgc8613b6"><a id="ID-405ec72e-7b79-4d96-aa32-1a3f931dd5a4"></a>sql-op :+, :*, :%, :&amp;, :|, :||, :and, :or, :=, :/, :!=, :&lt;, :&gt;, :&lt;=, :&gt;=, :^, :union, :union-all, :intersect, :intersect-all, :except, :except-all (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgc8613b6">
<p>
These are expanded as infix operators. When meaningful, they allow more than
two arguments. :- can also be used as a unary operator to negate a value.
Note that the arguments to :union, :union-all, :intersect, and :except
should be queries (:select forms).
</p>

<p>
Note that you'll have to escape pipe characters to enter them as keywords. S-SQL
handles the empty keyword symbol (written :||) specially, and treats it like :\|\|,
so that it can be written without escapes. With :\|, this doesn't work.
</p>
</div>
</div>

<div id="outline-container-org7d6a767" class="outline-3">
<h3 id="org7d6a767"><a id="ID-1604e97e-40e9-4fca-bf0a-897850766386"></a>sql-op :~, :not (arg)</h3>
<div class="outline-text-3" id="text-org7d6a767">
<p>
Unary operators for bitwise and logical negation.
</p>
</div>
</div>

<div id="outline-container-org189aa10" class="outline-3">
<h3 id="org189aa10"><a id="ID-55203563-3759-427f-8147-2396c642144d"></a>sql-op :function (name (&amp;rest arg-types) return-type stability body)</h3>
<div class="outline-text-3" id="text-org189aa10">
<p>
Create a stored procedure. The argument and return types are interpreted as
type names and not evaluated. Stability should be one of :immutable, :stable,
or :volatile (see the PostgreSQL documentation). For example, a function that
gets foobars by id:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #98fb98; font-weight: bold;">:function</span> 'get-foobar (integer) foobar <span style="color: #98fb98; font-weight: bold;">:stable</span> (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'foobar <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id '$1)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org55e7372" class="outline-3">
<h3 id="org55e7372"><a id="ID-228320ed-6925-4a55-92c8-b48066f7e02c"></a>sql-op :~, :~*, :!~, :!~* (string pattern)</h3>
<div class="outline-text-3" id="text-org55e7372">
<p>
Regular expression matching operators. The exclamation mark means 'does not match',
the asterisk makes the match case-insensitive.
</p>
</div>
</div>

<div id="outline-container-org985aa3e" class="outline-3">
<h3 id="org985aa3e"><a id="ID-89ce2b9e-50d8-4376-99e5-b085639f2cae"></a>sql-op :like, :ilike (string pattern)</h3>
<div class="outline-text-3" id="text-org985aa3e">
<p>
Simple SQL string matching operators (:ilike is case-insensitive).
</p>
</div>
</div>

<div id="outline-container-orga1bf114" class="outline-3">
<h3 id="orga1bf114"><a id="ID-7e33f04a-09f8-4177-bf8b-ae6f42eb33cc"></a>sql-op :@@</h3>
<div class="outline-text-3" id="text-orga1bf114">
<p>
Fast Text Search match operator.
</p>
</div>
</div>

<div id="outline-container-org5c95fb8" class="outline-3">
<h3 id="org5c95fb8"><a id="ID-bfa41b7a-e1be-42be-b1b7-ecaa0913391c"></a>sql-op :desc (column)</h3>
<div class="outline-text-3" id="text-org5c95fb8">
<p>
Used to invert the meaning of an operator in an :order-by clause.
</p>
</div>
</div>

<div id="outline-container-org50bd3ad" class="outline-3">
<h3 id="org50bd3ad"><a id="ID-53293652-8d98-40fb-b629-7f3350a1b16c"></a>sql-op :nulls-first, :nulls-last (column)</h3>
<div class="outline-text-3" id="text-org50bd3ad">
<p>
Used to determine where :null values appear in an :order-by clause.
</p>
</div>
</div>

<div id="outline-container-org5c3fbc5" class="outline-3">
<h3 id="org5c3fbc5"><a id="ID-ca6fe6aa-07ad-4931-afe5-9d9087059dca"></a>sql-op :as (form name &amp;rest fields)</h3>
<div class="outline-text-3" id="text-org5c3fbc5">
<p>
Assigns a name to a column or table in a :select form. When fields are given,
they are added after the name, in parentheses. For example, (:as 'table1 't1 'foo 'bar)
becomes table1 AS t1(foo, bar). When you need to specify types for the fields,
you can do something like (:as 'table2 't2 ('foo integer)). Note that names are
quoted, types are not (when using sql-compile or sql-template, you can leave
out the quotes entirely).
</p>
</div>
</div>

<div id="outline-container-org3c26ab7" class="outline-3">
<h3 id="org3c26ab7"><a id="ID-fdab4fe0-46bb-4240-b629-773c21b8d304"></a>sql-op :cast (query)</h3>
<div class="outline-text-3" id="text-org3c26ab7">
<p>
The CAST operator. Takes a query as an argument, and returns the result
explicitly cast by postgresql to a specific type.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:cast</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> <span style="color: #cd8162;">"20"</span> 'integer)))
        <span style="color: #98fb98; font-weight: bold;">:single</span>)
20

(query (<span style="color: #98fb98; font-weight: bold;">:union</span> (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 1 'real))
               (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:cast</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> <span style="color: #cd8162;">"2.2"</span> 'real)))))
((1.0) (2.2))
</pre>
</div>
</div>
</div>
<div id="outline-container-org574a8d2" class="outline-3">
<h3 id="org574a8d2"><a id="ID-249f05e6-b7c7-4b53-a215-73673f9aa2b0"></a>sql-op :type (query)</h3>
<div class="outline-text-3" id="text-org574a8d2">
<p>
Is similar to cast but uses the postgresql :: formating. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:-</span> (<span style="color: #98fb98; font-weight: bold;">:type</span> (<span style="color: #98fb98; font-weight: bold;">:now</span>) date) 'x) 'some-date) <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:generate-series</span> 1 10) 'x)))

<span style="color: #cd8162;">"(SELECT (now()::DATE - x) AS some_date FROM generate_series(1, 10) AS x)"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3588737" class="outline-3">
<h3 id="org3588737"><a id="ID-6fdeb899-f180-47f7-b8e1-6ad314c7952b"></a>sql-op :create-composite-type (type-name &amp;rest args)</h3>
<div class="outline-text-3" id="text-org3588737">
<p>
Creates a composite type with a type-name and two or more columns. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:create-composite-type</span> 'fullname (first-name text) (last-name text)))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc773f87" class="outline-3">
<h3 id="orgc773f87"><a id="ID-edab7fef-c6c1-4875-8b41-54bf05242554"></a>sql-op :exists (query)</h3>
<div class="outline-text-3" id="text-orgc773f87">
<p>
The EXISTS operator. Takes a query as an argument, and returns true or false
depending on whether that query returns any rows.
</p>
</div>
</div>

<div id="outline-container-org2249114" class="outline-3">
<h3 id="org2249114"><a id="ID-48e3d777-1fde-4e60-b8d2-d8f7b8fea7bf"></a>sql-op :is-null (arg)</h3>
<div class="outline-text-3" id="text-org2249114">
<p>
Test whether a value is null.
</p>
</div>
</div>

<div id="outline-container-orgf2a8612" class="outline-3">
<h3 id="orgf2a8612"><a id="ID-74c212eb-330e-459a-bdc4-2d2e75046972"></a>sql-op :not-null (arg)</h3>
<div class="outline-text-3" id="text-orgf2a8612">
<p>
Test whether a value is not null.
</p>
</div>
</div>
<div id="outline-container-org0cd468f" class="outline-3">
<h3 id="org0cd468f"><a id="ID-45c17b50-7b34-42d9-8dd2-08ccd12fa7c0"></a>sql-op :in (value set)</h3>
<div class="outline-text-3" id="text-org0cd468f">
<p>
Test whether a value is in a set of values.
</p>
</div>
</div>

<div id="outline-container-org373cf09" class="outline-3">
<h3 id="org373cf09"><a id="ID-f8f9f42f-00b7-4b17-b2fb-2ef90dd8ec2c"></a>sql-op :not-in (value set)</h3>
<div class="outline-text-3" id="text-org373cf09">
<p>
Inverse of the above.
</p>
</div>
</div>

<div id="outline-container-orgb64328b" class="outline-3">
<h3 id="orgb64328b"><a id="ID-72eea20e-6e5f-4a9a-ba2f-f5f23327b397"></a>sql-op :set (&amp;rest elements)</h3>
<div class="outline-text-3" id="text-orgb64328b">
<p>
Denote a set of values. This operator has two interfaces. When
the elements are known at compile-time, they can be given as
multiple arguments to the operator. When they are not, a
single argument that evaluates to a list should be used.
</p>
</div>
</div>

<div id="outline-container-orgd0e4ad2" class="outline-3">
<h3 id="orgd0e4ad2"><a id="ID-f7a7e6fb-00f9-407b-b929-78f17e164052"></a>sql-op :array (query)</h3>
<div class="outline-text-3" id="text-orgd0e4ad2">
<p>
This is used when calling a select query into an array.  See <a href="array-notes.html">array-notes.html</a>
for more detailed notes on the use of arrays.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:order-by</span>
        (<span style="color: #98fb98; font-weight: bold;">:select</span> 'r.rolename
                 (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:array</span>
                       (<span style="color: #98fb98; font-weight: bold;">:select</span> 'b.rolename
                                <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'pg_catalog.pg-auth-members 'm)
                                <span style="color: #98fb98; font-weight: bold;">:inner-join</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'pg-catalog.pg-roles 'b)
                                <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'm.roleid 'b.oid)
                                <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'm.member 'r.oid )))
                      'memberof)

                 <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'pg-catalog.pg-roles 'r))
        1))

</pre>
</div>
</div>
</div>

<div id="outline-container-org57c74e1" class="outline-3">
<h3 id="org57c74e1"><a id="ID-1b9af15e-051a-401f-a251-1a7173685c9e"></a>sql-op :array[] (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org57c74e1">
<p>
This is the general operator for arrays. It also handles statements that include
functions in the query such as (:+ 1 2), (:pi) in the array. See <a href="array-notes.html">array-notes.html</a>
for more detailed notes on the use of arrays.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:array-prepend</span> 1 (<span style="color: #98fb98; font-weight: bold;">:array[]</span> 2 3))))

((#(1 2 3)))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:array-prepend</span> 1 (<span style="color: #98fb98; font-weight: bold;">:array[]</span> 2 3)))
       <span style="color: #98fb98; font-weight: bold;">:single</span>)

#(1 2 3)
</pre>
</div>
</div>
</div>

<div id="outline-container-org91e0ff6" class="outline-3">
<h3 id="org91e0ff6"><a id="ID-7afc83f1-4054-4a6c-8ea2-99549e037998"></a>sql-op :[] (form start &amp;optional end)</h3>
<div class="outline-text-3" id="text-org91e0ff6">
<p>
Dereference an array value. If end is provided, extract a slice of the array.
Sample usage below, but also see <a href="array-notes.html">array-notes.html</a> for more detailed notes on
the use of arrays.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'receipe-id (<span style="color: #98fb98; font-weight: bold;">:[]</span> 'tags 2 3)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'receipe-tags-array
                <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'receipe-id 3)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e86d82" class="outline-3">
<h3 id="org9e86d82"><a id="ID-2ed4ee9b-b199-43df-9b4b-f33d67629793"></a>sql-op :extract (unit form)</h3>
<div class="outline-text-3" id="text-org9e86d82">
<p>
Extract a field from a date/time value. For example, (:extract :month (:now)).
</p>
</div>
</div>

<div id="outline-container-org9c66f32" class="outline-3">
<h3 id="org9c66f32"><a id="ID-95c998be-86a0-4553-ba2d-b1afa04205d6"></a>sql-op :case (&amp;rest clauses)</h3>
<div class="outline-text-3" id="text-org9c66f32">
<p>
A conditional expression. Clauses should take the form (test value). If
test is :else, an ELSE clause will be generated.
</p>
</div>
</div>

<div id="outline-container-org57ac1f5" class="outline-3">
<h3 id="org57ac1f5"><a id="ID-3eb62a27-e798-47c9-99a3-34efb86b0a6e"></a>sql-op :between (n start end)</h3>
<div class="outline-text-3" id="text-org57ac1f5">
<p>
Test whether a value lies between two other values.
</p>
</div>
</div>

<div id="outline-container-org4e09b12" class="outline-3">
<h3 id="org4e09b12"><a id="ID-7acf3e85-924c-42cb-84ec-4ab0430f6fc0"></a>sql-op :between-symmetric (n start end)</h3>
<div class="outline-text-3" id="text-org4e09b12">
<p>
Works like :between, except that the start value is not required to be
less than the end value.
</p>
</div>
</div>

<div id="outline-container-orgcc5a08f" class="outline-3">
<h3 id="orgcc5a08f"><a id="ID-5d7287f0-9527-46da-8bc7-8220b49b53a2"></a>sql-op :dot (&amp;rest names)</h3>
<div class="outline-text-3" id="text-orgcc5a08f">
<p>
Can be used to combine multiple names into a name of the form A.B to
refer to a column in a table, or a table in a schema. Note that you
can also just use a symbol with a dot in it.
</p>
</div>
</div>

<div id="outline-container-orgae524fd" class="outline-3">
<h3 id="orgae524fd"><a id="ID-ccedb33a-7e65-4a25-9e0a-a5611665c9a8"></a>sql-op :type (form type)</h3>
<div class="outline-text-3" id="text-orgae524fd">
<p>
Add a type declaration to a value, as in in "4.3::real". The second
argument is not evaluated normally, but put through sql-type-name to
get a type identifier.
</p>
</div>
</div>

<div id="outline-container-org2e6bd1a" class="outline-3">
<h3 id="org2e6bd1a"><a id="ID-4833bb9a-223b-4d29-a9ca-8e243abb1fab"></a>sql-op :raw (string)</h3>
<div class="outline-text-3" id="text-org2e6bd1a">
<p>
Insert a string as-is into the query. This can be useful for doing things
that the syntax does not support, or to re-use parts of a query across
multiple queries:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">let*</span> ((test (sql (<span style="color: #98fb98; font-weight: bold;">:and</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'foo 22) (<span style="color: #98fb98; font-weight: bold;">:not-null</span> 'bar))))
       (rows (query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'baz <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:raw</span> test)))))
  (query (<span style="color: #98fb98; font-weight: bold;">:delete-from</span> 'baz <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:raw</span> test)))
  (<span style="color: #00ffff;">do-stuff</span> rows))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6c19170" class="outline-3">
<h3 id="org6c19170"><a id="ID-1b0cc29f-7b0a-4bca-8f79-5e763fc9a356"></a>sql-op :limit (query amount &amp;optional offset)</h3>
<div class="outline-text-3" id="text-org6c19170">
<p>
In S-SQL limit is not part of the select operator, but an extra
operator that is applied to a query (this works out better when limiting
the union or intersection of multiple queries, same for sorting).
It limits the number of results to the amount given as the second
argument, and optionally offsets the result by the amount given
as the third argument.
</p>
</div>
</div>

<div id="outline-container-org5abe831" class="outline-3">
<h3 id="org5abe831"><a id="ID-df5b679e-5f4b-4599-b533-82c3e9d4f13b"></a>sql-op :order-by (query &amp;rest exprs)</h3>
<div class="outline-text-3" id="text-org5abe831">
<p>
Order the results of a query by the given expressions. See :desc for
when you want to invert an ordering. Note: This is not the same as
passing an :order-by parameter to an aggregation operator.
See Aggregation Operators.
</p>
</div>
</div>

<div id="outline-container-orgb115768" class="outline-3">
<h3 id="orgb115768"><a id="ID-d7cc1523-6341-4d80-a08a-c76898a99501"></a>sql-op :values</h3>
<div class="outline-text-3" id="text-orgb115768">
<p>
Values computes a row value or set of row values for use in a specific
query. See the postgresql docs at:
<a href="https://www.postgresql.org/docs/current/static/queries-values.html">https://www.postgresql.org/docs/current/static/queries-values.html</a>
and <a href="https://www.postgresql.org/docs/current/static/sql-values.html">https://www.postgresql.org/docs/current/static/sql-values.html</a>
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '*
                <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:values</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> 1 <span style="color: #cd8162;">"one"</span>)
                                    (<span style="color: #98fb98; font-weight: bold;">:set</span> 2 <span style="color: #cd8162;">"two"</span>)
                                    (<span style="color: #98fb98; font-weight: bold;">:set</span> 3 <span style="color: #cd8162;">"three"</span>))
                           (<span style="color: #98fb98; font-weight: bold;">:t1</span> 'num 'letter))))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'a 'b 'c (<span style="color: #98fb98; font-weight: bold;">:cast</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:*</span> 50 (<span style="color: #98fb98; font-weight: bold;">:random</span>)) 'int))
                <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:values</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> <span style="color: #cd8162;">"a"</span>) (<span style="color: #98fb98; font-weight: bold;">:set</span> <span style="color: #cd8162;">"b"</span>)) (<span style="color: #98fb98; font-weight: bold;">:d1</span> 'a))
                (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:values</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> <span style="color: #cd8162;">"c"</span>) (<span style="color: #98fb98; font-weight: bold;">:set</span> <span style="color: #cd8162;">"d"</span>)) (<span style="color: #98fb98; font-weight: bold;">:d2</span> 'b))
                (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:values</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> <span style="color: #cd8162;">"e"</span>) (<span style="color: #98fb98; font-weight: bold;">:set</span> <span style="color: #cd8162;">"f"</span>)) (<span style="color: #98fb98; font-weight: bold;">:d3</span> 'c))))

(query
 (<span style="color: #00ffff;">:with-recursive</span>
  (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:t1</span> 'n)
       (<span style="color: #98fb98; font-weight: bold;">:union-all</span> (<span style="color: #98fb98; font-weight: bold;">:values</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> 1))
                   (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:+</span> 'n 1)
                            <span style="color: #98fb98; font-weight: bold;">:from</span> 't1
                            <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'n 100))))
  (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'n) <span style="color: #98fb98; font-weight: bold;">:from</span> 't1))
 <span style="color: #98fb98; font-weight: bold;">:single</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org194be4e" class="outline-3">
<h3 id="org194be4e"><a id="ID-a7daaf56-9824-4a6f-8ada-313221e034cb"></a>sql-op :empty-set</h3>
<div class="outline-text-3" id="text-org194be4e">
<p>
This is a fudge. It returns a string "()" where something like '()
would return "false" or :() would throw an error. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'appnumber 'day (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'inserts)
                (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'updates) (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'deletes) (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'transactions)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'db-details
                <span style="color: #98fb98; font-weight: bold;">:group-by</span> (<span style="color: #98fb98; font-weight: bold;">:grouping-sets</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> 'appnumber 'day (<span style="color: #98fb98; font-weight: bold;">:empty-set</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ed59e3" class="outline-3">
<h3 id="org7ed59e3"><a id="ID-8f5b4a28-a801-424d-9ff6-4460fa7f048d"></a>sql-op :group-by</h3>
<div class="outline-text-3" id="text-org7ed59e3">
<p>
<a href="https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS">https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS</a>
The GROUP BY Clause is used to group together those rows in a table that
have the same values in all the columns listed. The order in which the
columns are listed does not matter. The effect is to combine each set of
rows having common values into one group row that represents all rows in
the group. This is done to eliminate redundancy in the output and/or compute
aggregates that apply to these groups. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:order-by</span>
        (<span style="color: #98fb98; font-weight: bold;">:select</span> 'mems.surname 'mems.firstname 'mems.memid (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:min</span> 'bks.starttime) 'starttime)
                 <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'cd.bookings 'bks)
                 <span style="color: #98fb98; font-weight: bold;">:inner-join</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'cd.members 'mems)
                 <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'mems.memid 'bks.memid)
                 <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&gt;=</span> 'starttime <span style="color: #cd8162;">"2012-09-01"</span>)
                 <span style="color: #98fb98; font-weight: bold;">:group-by</span> 'mems.surname 'mems.firstname 'mems.memid)
        'mems.memid))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9b3333b" class="outline-3">
<h3 id="org9b3333b"><a id="ID-dfcde273-6c53-488a-b8d2-43adc3a95d23"></a>sql-op :grouping-sets</h3>
<div class="outline-text-3" id="text-org9b3333b">
<p>
<a href="https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS">https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS</a>
More complex grouping operations are possible using the concept of grouping
sets. The data selected by the FROM and WHERE clauses is grouped separately
by each specified grouping set, aggregates computed for each group just as
for simple GROUP BY clauses, and then the results returned.
This operator requires postgresql 9.5 or later. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'city (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:extract</span> 'year 'start-date)  'joining-year) (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:count</span> 1) 'employee_count)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee
                <span style="color: #98fb98; font-weight: bold;">:group-by</span> (<span style="color: #98fb98; font-weight: bold;">:grouping-sets</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> 'city (<span style="color: #98fb98; font-weight: bold;">:extract</span> 'year 'start-date)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org587c3a5" class="outline-2">
<h2 id="org587c3a5"><a id="ID-d07d0cf2-6766-4b7a-af0b-57a0c2b754eb"></a>Time, Date and Interval Operators</h2>
<div class="outline-text-2" id="text-org587c3a5">
</div>
<div id="outline-container-orgc69ded6" class="outline-3">
<h3 id="orgc69ded6"><a id="ID-330de3f2-1869-47a2-8a0d-467a38e3254f"></a>sql-op :interval (arg)</h3>
<div class="outline-text-3" id="text-orgc69ded6">
<p>
Creates an interval data type, generally represented in postmodern as an alist
</p>
</div>
</div>
<div id="outline-container-org5445413" class="outline-3">
<h3 id="org5445413"><a id="ID-6d1cf4f1-89f8-4586-9e19-58c6003e5166"></a>sql-op :current-date ()</h3>
<div class="outline-text-3" id="text-org5445413">
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:current-date</span>)) <span style="color: #98fb98; font-weight: bold;">:single</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc6d6477" class="outline-3">
<h3 id="orgc6d6477"><a id="ID-2f80fe21-7abe-4eed-aa57-1b8a11cddfd1"></a>sql-op :current-time ()</h3>
<div class="outline-text-3" id="text-orgc6d6477">
</div>
</div>
<div id="outline-container-org084c77f" class="outline-3">
<h3 id="org084c77f"><a id="ID-5c124bd3-f248-45dd-9965-51c368cd3225"></a>sql-op :current-timestamp ()</h3>
<div class="outline-text-3" id="text-org084c77f">
</div>
</div>
<div id="outline-container-org3157bdf" class="outline-3">
<h3 id="org3157bdf"><a id="ID-1969c373-6093-46dc-9f41-001190399cbd"></a>sql-op :timestamp (arg)</h3>
<div class="outline-text-3" id="text-org3157bdf">
</div>
</div>
<div id="outline-container-org3369b59" class="outline-3">
<h3 id="org3369b59"><a id="ID-e4872980-3b59-4cd5-844b-ce8912160010"></a>sql-op :age (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org3369b59">
</div>
</div>
<div id="outline-container-orgad83347" class="outline-3">
<h3 id="orgad83347"><a id="ID-e155b65b-05d2-4583-a185-419817382e37"></a>sql-op :date (arg)</h3>
<div class="outline-text-3" id="text-orgad83347">
</div>
</div>
<div id="outline-container-org9613bb0" class="outline-3">
<h3 id="org9613bb0"><a id="ID-2794d9dd-9ab6-4d4b-8b9f-49056d214b67"></a>sql-op :make-interval (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org9613bb0">
<p>
Takes lists of (time-unit value) and returns a timestamp type. Example:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:make-interval</span> (<span style="color: #cd8162;">"days"</span> 4) (<span style="color: #cd8162;">"hours"</span> 10) (<span style="color: #cd8162;">"secs"</span> 1.2)))
       <span style="color: #98fb98; font-weight: bold;">:single</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb64e598" class="outline-3">
<h3 id="orgb64e598"><a id="ID-f4e7bf1a-25b1-4c2b-8794-9550164a0ee1"></a>sql-op :make-timestamp (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgb64e598">
<p>
Takes lists of (time-unit value) and returns a timestamptz type. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span>
          (<span style="color: #98fb98; font-weight: bold;">:make-timestamptz</span> (<span style="color: #cd8162;">"year"</span> 2014) (<span style="color: #cd8162;">"month"</span> 1) (<span style="color: #cd8162;">"mday"</span> 13)
                             (<span style="color: #cd8162;">"hour"</span> 21) (<span style="color: #cd8162;">"min"</span> 50) (<span style="color: #cd8162;">"sec"</span> 0)))
       <span style="color: #98fb98; font-weight: bold;">:single</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org7b1b4de" class="outline-3">
<h3 id="org7b1b4de"><a id="ID-b6f82034-e002-4dd2-9bde-ae025176cb9a"></a>sql-op :make-timestamptz (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org7b1b4de">
<p>
Takes lists of (time-unit value) and returns a timestamptz type. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span>
          (<span style="color: #98fb98; font-weight: bold;">:make-timestamptz</span> (<span style="color: #cd8162;">"year"</span> 2014) (<span style="color: #cd8162;">"month"</span> 1) (<span style="color: #cd8162;">"mday"</span> 13)
                             (<span style="color: #cd8162;">"hour"</span> 21) (<span style="color: #cd8162;">"min"</span> 50) (<span style="color: #cd8162;">"sec"</span> 0) (<span style="color: #cd8162;">"timezone"</span> <span style="color: #cd8162;">"Asia/Tokyo"</span>)))
       <span style="color: #98fb98; font-weight: bold;">:single</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbf8712f" class="outline-2">
<h2 id="orgbf8712f"><a id="ID-cd2bdccf-0de5-4b57-a195-0c94029e8c8e"></a>Aggregation Operators</h2>
<div class="outline-text-2" id="text-orgbf8712f">
</div>
<div id="outline-container-orgdfc4ea7" class="outline-3">
<h3 id="orgdfc4ea7"><a id="ID-40eed2a4-b3f5-4380-a3b7-16a5bdcbe0b3"></a>sql-op :count (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgdfc4ea7">
<p>
Count returns the number of rows for which the expression is not null.
It can be the number of rows collected by the select statement as in:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:count</span> '*)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'table1
                <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'price 100)))
</pre>
</div>

<p>
or it can be a smaller number of rows based on the allowed keyword
parameters :distinct and :filter or some other type of condition as in:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:count</span> 'memid <span style="color: #98fb98; font-weight: bold;">:distinct</span>)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'cd.bookings))
</pre>
</div>
<p>
or
</p>

<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:count</span> '* <span style="color: #98fb98; font-weight: bold;">:distinct</span>) 'unfiltered)
                (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:count</span> '* <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 1 'bid))
                     'filtered)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'testtable))
</pre>
</div>

<p>
Note that if used, the filter must be last in the count args. If distinct
is used, it must come before filter. Unlike standard sql, the word 'where'
is not used inside the filter clause. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:count</span> '*)
                (<span style="color: #98fb98; font-weight: bold;">:count</span> '* <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 1 'bid))
                'id
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'pbbench-history))
</pre>
</div>

<p>
See tests.lisp for examples.
</p>
</div>
</div>

<div id="outline-container-org063a112" class="outline-3">
<h3 id="org063a112"><a id="ID-0e6463d4-d83c-493b-8989-4819c6e9f914"></a>sql-op :avg (&amp;rest rest args)</h3>
<div class="outline-text-3" id="text-org063a112">
<p>
Avg calculates the average value of a list of values. Note that if the
filter keyword is used, the filter must be last in the avg args. If distinct
is used, it must come before filter. E.g. See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:avg</span> '*) (<span style="color: #98fb98; font-weight: bold;">:avg</span> '* <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 1 'bid)) 'id
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'pbbench-history))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd433f12" class="outline-3">
<h3 id="orgd433f12"><a id="ID-d8379b94-922b-47d3-9161-5da838b43f42"></a>sql-op :sum (&amp;rest rest args)</h3>
<div class="outline-text-3" id="text-orgd433f12">
<p>
Sum calculates the total of a list of values. Note that if the keyword filter
is used, the filter must be last in the sum args. If distinct is used, it
must come before filter. Unlike standard sql, the word 'where' is not used
inside the filter clause (s-sql will properly expand it). See tests.lisp
for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:sum</span> '*) (<span style="color: #98fb98; font-weight: bold;">:sum</span> '* <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 1 'bid)) 'id
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'pbbench-history))
</pre>
</div>
</div>
</div>

<div id="outline-container-org38017f3" class="outline-3">
<h3 id="org38017f3"><a id="ID-66db79ad-e7d4-43dd-a6af-fe3085c16d12"></a>sql-op ::max (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org38017f3">
<p>
max returns the maximum value of a set of values. Note that if the filter
keyword is used, the filter must be last in the max args. If distinct is
used, it must come before filter. Unlike standard sql, the word 'where'
is not used inside the filter clause (s-sql will properly expand it).
See tests.lisp for more examples.
</p>

<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:max</span> '*) (<span style="color: #98fb98; font-weight: bold;">:max</span> '* <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 1 'bid)) 'id
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'pbbench-history))
</pre>
</div>
</div>
</div>
<div id="outline-container-org38666c1" class="outline-3">
<h3 id="org38666c1"><a id="ID-02c03a2a-114d-4b4b-8214-12411c979a0f"></a>sql-op ::min (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org38666c1">
<p>
min returns the minimum value of a set of values. Note that if the filter
keyword is used, the filter must be last in the min args. If distinct is
used, it must come before filter. Unlike standard sql, the word 'where'
is not used inside the filter clause (s-sql will properly expand it).
See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:min</span> '*) (<span style="color: #98fb98; font-weight: bold;">:min</span> '* <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 1 'bid)) 'id
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'pbbench-history))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf54716f" class="outline-3">
<h3 id="orgf54716f"><a id="ID-3683daea-ef97-4cb9-a78e-aa40fc3df983"></a>sql-op ::every (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgf54716f">
<p>
Every returns true if all input values are true, otherwise false. Note
that if the filter keyword is used, the filter must be last in the every
args. If distinct is used, it must come before filter. Unlike standard sql,
the word 'where' is not used inside the filter clause (s-sql will
properly expand it). See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* (<span style="color: #98fb98; font-weight: bold;">:every</span> (<span style="color: #98fb98; font-weight: bold;">:like</span> 'studname <span style="color: #cd8162;">"%h"</span>))
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'tbl-students
                <span style="color: #98fb98; font-weight: bold;">:group-by</span> 'studname 'studid 'studgrades))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge975bc9" class="outline-3">
<h3 id="orge975bc9"><a id="ID-3a6ee0b8-64cd-4937-b769-95f3ec44c32a"></a>sql-op :percentile-cont (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orge975bc9">
<p>
Requires Postgresql 9.4 or higher. Percentile-cont returns a value
corresponding to the specified fraction in the ordering, interpolating
between adjacent input items if needed. There are two required keyword
parameters :fraction and :order-by. If the fraction value is an array,
then it returns an array of results matching the shape of the fractions
parameter, with each non-null element replaced by the value corresponding
to that percentile. Examples:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:percentile-cont</span> <span style="color: #98fb98; font-weight: bold;">:fraction</span> 0.5 <span style="color: #98fb98; font-weight: bold;">:order-by</span> 'number-of-staff)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'schools))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:percentile-cont</span> <span style="color: #98fb98; font-weight: bold;">:fraction</span> array[0.25 0.5 0.75 1]
                                  <span style="color: #98fb98; font-weight: bold;">:order-by</span> 'number-of-staff)
                <span style="color: #98fb98; font-weight: bold;">:from</span>  'schools))
</pre>
</div>
</div>
</div>


<div id="outline-container-org748a418" class="outline-3">
<h3 id="org748a418"><a id="ID-5f53ac18-189b-4df7-99ac-02ebbd8a9606"></a>sql-op :percentile-dist (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org748a418">
<p>
Requires Postgresql 9.4 or higher. There are two required keyword parameters
:fraction and :order-by. Percentile-dist returns the first input value whose
position in the ordering equals or exceeds the specified fraction. If the
fraction parameter is an array eturns an array of results matching the shape
of the fractions parameter, with each non-null element replaced by the input
value corresponding to that percentile. Examples:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:percentile-dist</span> <span style="color: #98fb98; font-weight: bold;">:fraction</span> 0.5
                                  <span style="color: #98fb98; font-weight: bold;">:order-by</span> 'number-of-staff)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'schools))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:percentile-dist</span> <span style="color: #98fb98; font-weight: bold;">:fraction</span> array[0.25 0.5 0.75 1]
                                  <span style="color: #98fb98; font-weight: bold;">:order-by</span> 'number-of-staff)
                <span style="color: #98fb98; font-weight: bold;">:from</span>  'schools))

</pre>
</div>
</div>
</div>

<div id="outline-container-org1c058ab" class="outline-3">
<h3 id="org1c058ab"><a id="ID-36db9511-5ba0-4dfc-9646-71b2d47857b0"></a>sql-op :corr (y x)</h3>
<div class="outline-text-3" id="text-org1c058ab">
<p>
The corr function returns the correlation coefficient between a set of
dependent and independent variables. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:corr</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1535af" class="outline-3">
<h3 id="orgd1535af"><a id="ID-e6b20c69-d328-4a59-b030-9c03c9201305"></a>sql-op :covar-pop (y x)</h3>
<div class="outline-text-3" id="text-orgd1535af">
<p>
The covar-pop function returns the population covariance between a set of
dependent and independent variables. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:covar-pop</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org922a8ea" class="outline-3">
<h3 id="org922a8ea"><a id="ID-9112880c-0d43-43bb-96b0-416e4f1e2bc3"></a>sql-op :covar-samp (y x)</h3>
<div class="outline-text-3" id="text-org922a8ea">
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:covar-samp</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
<p>
The covar-samp function returns the sample covariance between a set of
dependent and independent variables. Example:
</p>
</div>
</div>

<div id="outline-container-org1581370" class="outline-3">
<h3 id="org1581370"><a id="ID-cd16b4cb-51f9-4bff-ac6e-7482fc2e1ffa"></a>sql-op :string-agg (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org1581370">
<p>
String-agg allows you to concatenate strings using different types of
delimiter symbols. Allowable optional keyword parameters are :distinct,
:order-by and :filter Note that order-by in string-agg requires
postgresql 9.0 or later. Filter requires postgresql 9.4 or later.
See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:string-agg</span> 'bp.step-type \",\" )
                     'step-summary)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'business-process))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'mid (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:string-agg</span>  'y \",\" <span style="color: #98fb98; font-weight: bold;">:distinct</span> <span style="color: #98fb98; font-weight: bold;">:order-by</span> (<span style="color: #98fb98; font-weight: bold;">:desc</span> 'y))
                          'words)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'moves))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:string-agg</span>  'name <span style="color: #cd8162;">","</span> <span style="color: #98fb98; font-weight: bold;">:order-by</span> (<span style="color: #98fb98; font-weight: bold;">:desc</span> 'name) <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 4))
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfc058e4" class="outline-3">
<h3 id="orgfc058e4"><a id="ID-dbf248ce-f480-4940-93d6-837aaa22529d"></a>sql-op :array-agg (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgfc058e4">
<p>
Array-agg returns a list of values concatenated into an arrays.
Allowable optional keyword parameters are :distinct, :order-by
and :filter.
</p>

<p>
Note that order-by in array-agg requires postgresql 9.0 or later.
Filter requires postgresql 9.4 or later. See <a href="array-notes.html">array-notes.html</a> for more
detailed notes on the use of arrays.
</p>

<p>
Example with Filter:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'g.id
                (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:array-agg</span> 'g.users <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'g.canonical \"Y\"))
                     'canonical-users)
                (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:array-agg</span> 'g.users <span style="color: #98fb98; font-weight: bold;">:filter</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'g.canonical \"N\"))
                     'non-canonical-users)
                <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'groups 'g)
                <span style="color: #98fb98; font-weight: bold;">:group-by</span> 'g.id))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd2e44f7" class="outline-3">
<h3 id="orgd2e44f7"><a id="ID-be548451-659d-46ca-b31b-9d308b8b5cba"></a>sql-op :mode (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgd2e44f7">
<p>
Mode is used to find the most frequent input value in a group.
See e.g. <a href="https://www.postgresql.org/docs/10/static/functions-aggregate.html#FUNCTIONS-ORDEREDSET-TABLE">https://www.postgresql.org/docs/10/static/functions-aggregate.html#FUNCTIONS-ORDEREDSET-TABLE</a>
and article at <a href="https://tapoueh.org/blog/2017/11/the-mode-ordered-set-aggregate-function">https://tapoueh.org/blog/2017/11/the-mode-ordered-set-aggregate-function</a>
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:mode</span> 'items)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'item-table))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ba67f1" class="outline-3">
<h3 id="org5ba67f1"><a id="ID-5c3e2dc0-d238-4116-91fd-a8111225ee94"></a>sql-op :regr_avgx (y x)</h3>
<div class="outline-text-3" id="text-org5ba67f1">
<p>
The regr_avgx function returns the average of the independent variable
(sum(X)/N) Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_avgx</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd75448f" class="outline-3">
<h3 id="orgd75448f"><a id="ID-2fc66640-03e7-4796-8209-69fba9f346a4"></a>sql-op :regr_avgy (y x)</h3>
<div class="outline-text-3" id="text-orgd75448f">
<p>
The regr_avgy function returns the average of the dependent variable
(sum(Y)/N). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">
</pre>
</div>
<p>
(query (:select (:regr_avgy 'height 'weight)
                :from 'people))
</p>
</div>
</div>
<div id="outline-container-orgd475897" class="outline-3">
<h3 id="orgd475897"><a id="ID-293a2e93-93bf-4c08-b0f4-6d3dfe0feb6b"></a>sql-op :regr_count (y x)</h3>
<div class="outline-text-3" id="text-orgd475897">
<p>
The regr_count function returns the number of input rows in which both
expressions are nonnull. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_count</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org185748d" class="outline-3">
<h3 id="org185748d"><a id="ID-8b92dc89-b251-4bac-ba53-58251e98d3f5"></a>sql-op :regr_intercept (y x)</h3>
<div class="outline-text-3" id="text-org185748d">
<p>
The regr_intercept function returns the y-intercept of the least-squares-fit
linear equation determined by the (X, Y) pairs. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_intercept</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd28d0c2" class="outline-3">
<h3 id="orgd28d0c2"><a id="ID-09020f6e-166a-40e8-85ea-fdaced1f7808"></a>sql-op :regr_r2 (y x)</h3>
<div class="outline-text-3" id="text-orgd28d0c2">
<p>
The regr_r2 function returns the square of the correlation coefficient. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_r2</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org255a831" class="outline-3">
<h3 id="org255a831"><a id="ID-b22a7906-c571-4463-884f-4067d51cf0ac"></a>sql-op :regr_slope (y x)</h3>
<div class="outline-text-3" id="text-org255a831">
<p>
The regr_slope function returns the slope of the least-squares-fit linear
equation determined by the (X, Y) pairs. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_slope</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2da276e" class="outline-3">
<h3 id="org2da276e"><a id="ID-9c7cc59e-419d-4161-9711-de2c9b0c27ec"></a>sql-op :regr_sxx (y x)</h3>
<div class="outline-text-3" id="text-org2da276e">
<p>
The regr_sxx function returns the sum(X^2) - sum(X)^2/N (“sum of squares” of
the independent variable). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_sxx</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1a032f9" class="outline-3">
<h3 id="org1a032f9"><a id="ID-24f03953-7fea-4b18-8d69-ccd5b6d9f1f5"></a>sql-op :regr_sxy (y x)</h3>
<div class="outline-text-3" id="text-org1a032f9">
<p>
The regr_sxy function returns the sum(X*Y) - sum(X) * sum(Y)/N (“sum of products”
of independent times dependent variable). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_sxy</span> 'height 'weight)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4de2313" class="outline-3">
<h3 id="org4de2313"><a id="ID-34f776b1-d29d-4d49-a66b-21262379510b"></a>sql-op :regr_syy (y x)</h3>
<div class="outline-text-3" id="text-org4de2313">
<p>
The regr_syy function returns the sum(Y^2) - sum(Y)^2/N (“sum of squares”
of the dependent variable). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:regr_syy</span> 'salary 'age)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge3008aa" class="outline-3">
<h3 id="orge3008aa"><a id="ID-e0558145-d8e0-4ea3-b9ae-cc92ef332b70"></a>sql-op :stddev (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orge3008aa">
<p>
The stddev function returns the the sample standard deviation of the input
values. It is a historical alias for stddev-samp. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:stddev</span> 'salary)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc44c19f" class="outline-3">
<h3 id="orgc44c19f"><a id="ID-e4eeac17-7d09-45d8-8589-47d9b09a95d2"></a>sql-op :stddev-pop (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgc44c19f">
<p>
The stddev-pop function returns the population standard deviation of the
input values. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:stddev-pop</span> 'salary)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgffc6d9d" class="outline-3">
<h3 id="orgffc6d9d"><a id="ID-4095965c-e969-4663-9ae4-2becfe72de7a"></a>sql-op :stddev-samp (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgffc6d9d">
<p>
The stddev-samp function returns the sample standard deviation of the
input values. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:stddev-samp</span> 'salary)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9f6d760" class="outline-3">
<h3 id="org9f6d760"><a id="ID-e4cd292a-4d33-434d-a698-4ae921a3173b"></a>sql-op :variance (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org9f6d760">
<p>
Variance is a historical alias for var_samp. The variance function returns
the sample variance of the input values (square of the sample standard deviation).
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:variance</span> 'salary)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga3887b6" class="outline-3">
<h3 id="orga3887b6"><a id="ID-d72f79cc-b7b1-4481-a93f-6d565c6a582b"></a>sql-op :var-pop (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orga3887b6">
<p>
The var-pop function returns the population variance of the input values
(square of the population standard deviation). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:var-pop</span> 'salary)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee)
       <span style="color: #98fb98; font-weight: bold;">:single</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6507f83" class="outline-3">
<h3 id="org6507f83"><a id="ID-12a5e8ba-4467-4411-a604-c8152c3fbc7d"></a>sql-op :var-samp (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org6507f83">
<p>
The var-samp function returns the sample variance of the input values
(square of the sample standard deviation). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:var-samp</span> 'salary)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'employee)
       <span style="color: #98fb98; font-weight: bold;">:single</span>)
</pre>
</div>

<p>
Window Functions
</p>
</div>
</div>
<div id="outline-container-orgea55393" class="outline-3">
<h3 id="orgea55393"><a id="ID-bb6eb9f2-d9ed-4348-9467-79cae9b78819"></a>sql-op :over (form &amp;rest args)</h3>
<div class="outline-text-3" id="text-orgea55393">
<p>
Over, partition-by and window are so-called window functions. A window
function performs a calculation across a set of table rows that are
somehow related to the current row.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'salary (<span style="color: #98fb98; font-weight: bold;">:over</span> (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'salary))
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'empsalary))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe7a4a4" class="outline-3">
<h3 id="orgbe7a4a4"><a id="ID-53d1397d-4f1d-4833-b0c1-79d18e943f8b"></a>sql-op :partition-by (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgbe7a4a4">
<p>
Args is a list of one or more columns to partition by, optionally
followed by an :order-by clause.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'depname 'subdepname 'empno 'salary
                (<span style="color: #98fb98; font-weight: bold;">:over</span> (<span style="color: #98fb98; font-weight: bold;">:avg</span> 'salary)
                       (<span style="color: #98fb98; font-weight: bold;">:partition-by</span> 'depname 'subdepname))
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'empsalary))
</pre>
</div>

<p>
Note the use of :order-by without parens:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'depname 'empno 'salary
                (<span style="color: #98fb98; font-weight: bold;">:over</span> (<span style="color: #98fb98; font-weight: bold;">:rank</span>)
                       (<span style="color: #98fb98; font-weight: bold;">:partition-by</span> 'depname <span style="color: #98fb98; font-weight: bold;">:order-by</span> (<span style="color: #98fb98; font-weight: bold;">:desc</span> 'salary)))
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'empsalary))
</pre>
</div>
</div>
</div>


<div id="outline-container-org231dcc7" class="outline-3">
<h3 id="org231dcc7"><a id="ID-63d29a3b-c105-4e09-ab3b-ca5e4ece17af"></a>sql-op :window (form)</h3>
<div class="outline-text-3" id="text-org231dcc7">
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:over</span> (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'salary) 'w)
                (<span style="color: #98fb98; font-weight: bold;">:over</span> (<span style="color: #98fb98; font-weight: bold;">:avg</span> 'salary) 'w)
                <span style="color: #98fb98; font-weight: bold;">:from</span> 'empsalary <span style="color: #98fb98; font-weight: bold;">:window</span>
                (<span style="color: #98fb98; font-weight: bold;">:as</span> 'w (<span style="color: #98fb98; font-weight: bold;">:partition-by</span> 'depname <span style="color: #98fb98; font-weight: bold;">:order-by</span> (<span style="color: #98fb98; font-weight: bold;">:desc</span> 'salary)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9bcb91" class="outline-3">
<h3 id="orgc9bcb91"><a id="ID-38fc8a49-9a90-4f6c-930f-c704964ec991"></a>sql-op :with (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgc9bcb91">
<p>
With provides a way to write auxillary statements for use in a larger query,
often referred to as Common Table Expressions or CTEs.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:with</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'upd
                   (<span style="color: #98fb98; font-weight: bold;">:parens</span>
                    (<span style="color: #98fb98; font-weight: bold;">:update</span> 'employees <span style="color: #98fb98; font-weight: bold;">:set</span> 'sales-count (<span style="color: #98fb98; font-weight: bold;">:+</span> 'sales-count 1)
                             <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id
                                        (<span style="color: #98fb98; font-weight: bold;">:select</span> 'sales-person
                                                 <span style="color: #98fb98; font-weight: bold;">:from</span> 'accounts
                                                 <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"Acme Corporation"</span>)))
                             <span style="color: #98fb98; font-weight: bold;">:returning</span> '*)))
              (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'employees-log
                            (<span style="color: #98fb98; font-weight: bold;">:select</span> '* (<span style="color: #98fb98; font-weight: bold;">:current-timestamp</span>) <span style="color: #98fb98; font-weight: bold;">:from</span>
                                     'upd))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb25245" class="outline-3">
<h3 id="orgbb25245"><a id="ID-78be2433-4c26-4e2c-b333-e234393b5dc1"></a>sql-op :with-recursive (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgbb25245">
<p>
Recursive modifier to a WITH statement, allowing the query to refer to its own output.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #00ffff;">:with-recursive</span>
      (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:t1</span> 'n)
           (<span style="color: #98fb98; font-weight: bold;">:union-all</span> (<span style="color: #98fb98; font-weight: bold;">:values</span> (<span style="color: #98fb98; font-weight: bold;">:set</span> 1))
                       (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:+</span> 'n 1)
                                <span style="color: #98fb98; font-weight: bold;">:from</span> 't1
                                <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'n 100))))
      (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'n) <span style="color: #98fb98; font-weight: bold;">:from</span> 't1)))

(query (<span style="color: #00ffff;">:with-recursive</span>
      (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:included_parts</span> 'sub-part 'part 'quantity)
           (<span style="color: #98fb98; font-weight: bold;">:union-all</span>
            (<span style="color: #98fb98; font-weight: bold;">:select</span> 'sub-part 'part 'quantity
                     <span style="color: #98fb98; font-weight: bold;">:from</span> 'parts
                     <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'part <span style="color: #cd8162;">"our-product"</span>))
            (<span style="color: #98fb98; font-weight: bold;">:select</span> 'p.sub-part 'p.part 'p.quantity
                     <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'included-parts 'pr)
                     (<span style="color: #98fb98; font-weight: bold;">:as</span> 'parts 'p)
                     <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'p.part 'pr.sub-part) )))
      (<span style="color: #98fb98; font-weight: bold;">:select</span> 'sub-part (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:sum</span> 'quantity) 'total-quantity)
               <span style="color: #98fb98; font-weight: bold;">:from</span> 'included-parts
               <span style="color: #98fb98; font-weight: bold;">:group-by</span> 'sub-part)))

(query (<span style="color: #00ffff;">:with-recursive</span>
      (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:search-graph</span> 'id 'link 'data 'depth)
           (<span style="color: #98fb98; font-weight: bold;">:union-all</span> (<span style="color: #98fb98; font-weight: bold;">:select</span> 'g.id 'g.link 'g.data 1
                                <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'graph 'g))
                       (<span style="color: #98fb98; font-weight: bold;">:select</span> 'g.id 'g.link 'g.data (<span style="color: #98fb98; font-weight: bold;">:+</span> 'sg.depth 1)
                                <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'graph 'g) (<span style="color: #98fb98; font-weight: bold;">:as</span> 'search-graph 'sg)
                                <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'g.id 'sg.link))))
      (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'search-graph)))

(query (<span style="color: #00ffff;">:with-recursive</span>
      (<span style="color: #98fb98; font-weight: bold;">:as</span> (<span style="color: #98fb98; font-weight: bold;">:search-graph</span> 'id 'link 'data'depth 'path 'cycle)
           (<span style="color: #98fb98; font-weight: bold;">:union-all</span>
            (<span style="color: #98fb98; font-weight: bold;">:select</span> 'g.id 'g.link 'g.data 1
                     (<span style="color: #98fb98; font-weight: bold;">:[]</span> 'g.f1 'g.f2) nil
                     <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'graph 'g))
            (<span style="color: #98fb98; font-weight: bold;">:select</span> 'g.id 'g.link 'g.data (<span style="color: #98fb98; font-weight: bold;">:+</span> 'sg.depth 1)
                     (:|| 'path (<span style="color: #98fb98; font-weight: bold;">:row</span> 'g.f1 'g.f2))
                     (<span style="color: #98fb98; font-weight: bold;">:=</span> (<span style="color: #98fb98; font-weight: bold;">:row</span> 'g.f1 'g.f2)
                         (<span style="color: #98fb98; font-weight: bold;">:any*</span> 'path))
                     <span style="color: #98fb98; font-weight: bold;">:from</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'graph 'g)
                     (<span style="color: #98fb98; font-weight: bold;">:as</span> 'search-graph 'sg)
                     <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:and</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'g.id 'sg.link)
                                  (<span style="color: #98fb98; font-weight: bold;">:not</span> 'cycle)))))
      (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'search-graph)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2ba61ef" class="outline-2">
<h2 id="org2ba61ef"><a id="ID-dbedabf5-eaf5-4adb-b323-b42926acc81a"></a>Table Functions</h2>
<div class="outline-text-2" id="text-org2ba61ef">
</div>
<div id="outline-container-org67fc5b4" class="outline-3">
<h3 id="org67fc5b4"><a id="ID-ace310e6-8bd1-4211-bf66-ef56c9b7e872"></a>sql-op :for-update (query &amp;key of nowait)</h3>
<div class="outline-text-3" id="text-org67fc5b4">
<p>
Locks the selected rows against concurrent updates. This will prevent the
rows from being modified or deleted by other transactions until the current
transaction ends. The :of keyword should be followed by one or more table
names. If provided, PostgreSQL will lock these tables instead of the ones
detected in the select statement. The :nowait keyword should be provided
by itself (with no argument attached to it), after all the :of arguments.
If :nowait is provided, PostgreSQL will throw an error if a table cannot be
locked immediately, instead of pausing until it's possible.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:for-update</span> (<span style="color: #98fb98; font-weight: bold;">:select</span> <span style="color: #98fb98; font-weight: bold;">:*</span> <span style="color: #98fb98; font-weight: bold;">:from</span> 'foo 'bar 'baz) <span style="color: #98fb98; font-weight: bold;">:of</span> 'bar 'baz <span style="color: #98fb98; font-weight: bold;">:nowait</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc58d7be" class="outline-3">
<h3 id="orgc58d7be"><a id="ID-457394be-ef0d-444a-ad33-fefbc39363e3"></a>sql-op :for-share (query &amp;key of nowait)</h3>
<div class="outline-text-3" id="text-orgc58d7be">
<p>
Similar to :for-update, except it acquires a shared lock on the table,
allowing other transactions to perform :for-share selects on the locked
tables.
</p>
</div>
</div>

<div id="outline-container-org9c35d1b" class="outline-3">
<h3 id="org9c35d1b"><a id="ID-a63202ff-4aa9-4af3-9b82-254516db07e1"></a>sql-op :insert-into (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-org9c35d1b">
<p>
Insert a row into a table. When the second argument is :set, the other
arguments should be alternating field names and values, otherwise it
should be a :select form that will produce the values to be inserted.
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'my-table <span style="color: #98fb98; font-weight: bold;">:set</span> 'field-1 42 'field-2 <span style="color: #cd8162;">"foobar"</span>))
</pre>
</div>

<p>
It is possible to add :returning, followed by a list of field names or
expressions, at the end of the :insert-into form. This will cause the
query to return the values of these expressions as a single row.
</p>

<p>
In postgresql versions 9.5 and above, it is possible to add
:on-conflict-do-nothing (if the item already exists, do nothing),
or :on-conflict-update (if the item already exists, update the values)
followed by a list of field names which are checked for the conflict
then using :update-set followed by a list of field names or expressions
following the syntax for updating a table. This is sometimes called
an "upsert". Note that as per the postgresql sql documentation you must
prepend the table name to the column in the where statement if you are updating.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-table <span style="color: #98fb98; font-weight: bold;">:set</span> 'column-A '$1 'column-B '$2
                     <span style="color: #98fb98; font-weight: bold;">:on-conflict-update</span> 'column-A
                     <span style="color: #98fb98; font-weight: bold;">:update-set</span> 'column-B '$2
                     <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'test-table.column-A '$1)) <span style="color: #cd8162;">"c"</span> 37)
</pre>
</div>
</div>
</div>

<div id="outline-container-org84686d9" class="outline-3">
<h3 id="org84686d9"><a id="ID-26d60b83-60f5-4bb4-8a03-cd897a455139"></a>sql-op :insert-rows-into (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-org84686d9">
<p>
Insert multiple rows into a table. Specify the columns first with the
keyword :columns then provide a list of lists of the values as a
parameter to the keyword :values. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:insert-rows-into</span> 'my-table <span style="color: #98fb98; font-weight: bold;">:columns</span> 'field-1 'field-2
                                    <span style="color: #98fb98; font-weight: bold;">:values</span> '((42 <span style="color: #cd8162;">"foobar"</span>) (23 <span style="color: #cd8162;">"foobaz"</span>))))
</pre>
</div>

<p>
If you will use the default columns, this can be simplified and the :columns
parameters can be dropped. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:insert-rows-into</span> 'my-table
                          <span style="color: #98fb98; font-weight: bold;">:values</span> '((42 <span style="color: #cd8162;">"foobar"</span>) (23 <span style="color: #cd8162;">"foobaz"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge0ce1c8" class="outline-3">
<h3 id="orge0ce1c8"><a id="ID-bbf790c1-9baa-4cf0-900c-16a5a2bc2081"></a>sql-op :update (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-orge0ce1c8">
<p>
Update values in a table. After the table name there should follow the
keyword :set and any number of alternating field names and values, like
for :insert-into. Next comes the optional keyword :from, followed by at
least one table name and then any number of join statements, like for
:select. After the joins, an optional :where keyword followed by the condition,
and :returning keyword followed by a list of field names or expressions
indicating values to be returned as query result.
</p>
</div>
</div>

<div id="outline-container-org8ac39db" class="outline-3">
<h3 id="org8ac39db"><a id="ID-cdee608e-71cb-4d41-9e1d-a21b7728d956"></a>sql-op :delete-from (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-org8ac39db">
<p>
Delete rows from the named table. Can be given a :where argument followed
by a condition, and a :returning argument, followed by one or more
expressions that should be returned for every deleted row.
</p>
</div>
</div>

<div id="outline-container-org85099f7" class="outline-3">
<h3 id="org85099f7"><a id="ID-4096efd3-8b88-4c50-8a02-d3f1a1b0d682"></a>sql-op :create-table (name (&amp;rest columns) &amp;rest options)</h3>
<div class="outline-text-3" id="text-org85099f7">
<p>
Create a new table. The simplest example would pass two parameters,
the table name and a list of lists providing information for each column.
For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:create-table</span> 'george ((id <span style="color: #98fb98; font-weight: bold;">:type</span> integer))))
</pre>
</div>
<p>
where 'george is the name of the table, it has 1 column named id
which is limited to integers. There are no indexes or keys in this
example.
</p>

<p>
See <a href="create-tables.html">create-tables.html</a> for more detailed examples.
</p>
</div>

<div id="outline-container-org61479f3" class="outline-4">
<h4 id="org61479f3"><a id="ID-d0a01fab-1489-47dd-8307-30c28351e8af"></a>Column Definition parameters</h4>
<div class="outline-text-4" id="text-org61479f3">
<p>
After the table name a list of column definitions
follows, which are lists that start with a name, followed by one or
more of the following keyword arguments:
</p>

<ul class="org-ul">
<li>:type</li>
</ul>

<p>
This one is required. It specifies the type of the column. Use a type like
(or db-null integer) to specify a column that may have NULL values.
</p>

<ul class="org-ul">
<li>:default</li>
</ul>

<p>
Provides a default value for the field.
</p>

<ul class="org-ul">
<li>:unique</li>
</ul>

<p>
If this argument is non-nil, the values of the column must be unique.
</p>

<ul class="org-ul">
<li>:primary-key</li>
</ul>

<p>
When non-nil, the column is a primary key of the table.
</p>

<ul class="org-ul">
<li>:check</li>
</ul>

<p>
Adds a constraint to this column. The value provided for this argument must
be an S-SQL expression that returns a boolean value. It can refer to other
columns in the table if needed.
</p>

<ul class="org-ul">
<li>:references</li>
</ul>

<p>
Adds a foreign key constraint to this table. The argument provided must be a
list of the form (target &amp;optional on-delete on-update). When target is a
symbol, it names the table to whose primary key this constraint refers. When
it is a list, its first element is the table, and its second element the
column within that table that the key refers to. on-delete and on-update
can be used to specify the actions that must be taken when the row that this
key refers to is deleted or changed. Allowed values are :restrict, :set-null,
</p>

<ul class="org-ul">
<li>:set-default, :cascade, and :no-action.</li>
</ul>
</div>
</div>

<div id="outline-container-org0f04e4a" class="outline-4">
<h4 id="org0f04e4a"><a id="ID-6ee6a88c-1810-41f9-8cad-2c7d347f9c4a"></a>Table Constraints</h4>
<div class="outline-text-4" id="text-org0f04e4a">
<p>
After the list of columns, zero or more extra options (table constraints) can
be specified. These are lists starting with one of the following keywords:
</p>

<ul class="org-ul">
<li>:check</li>
</ul>

<p>
Adds a constraint to the table. Takes a single S-SQL expression that produces
a boolean as its argument.
</p>

<ul class="org-ul">
<li>:primary-key</li>
</ul>

<p>
Specifies a primary key for the table. The arguments to this option are the
names of the columns that this key consists of.
</p>

<ul class="org-ul">
<li>:unique</li>
</ul>

<p>
Adds a unique constraint to a group of columns. Again, the arguments are a
list of symbols that indicate the relevant columns.
</p>

<ul class="org-ul">
<li>:foreign-key</li>
</ul>

<p>
Create a foreign key. The arguments should have the form
(columns target &amp;optional on-delete on-update), where columns is a list of
columns that are used by this key, while the rest of the arguments have
the same meaning as they have in the :references option for columns.
Every list can start with :constraint name to create a specifically named
constraint.
</p>

<p>
Note that, unlike most other operators, :create-table expects most of its
arguments to be unquoted symbols. The exception to this is the value
of :check constraints: These must be normal S-SQL expressions, which means
that any column names they contain should be quoted. When programmatically
generating table definitions, sql-compile is usually more practical than
the sql macro.
</p>

<p>
Here is an example of a :create-table form:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #98fb98; font-weight: bold;">:create-table</span> enemy
  ((name <span style="color: #98fb98; font-weight: bold;">:type</span> string <span style="color: #98fb98; font-weight: bold;">:primary-key</span> t)
   (age <span style="color: #98fb98; font-weight: bold;">:type</span> integer)
   (address <span style="color: #98fb98; font-weight: bold;">:type</span> (or db-null string) <span style="color: #98fb98; font-weight: bold;">:references</span> (important-addresses <span style="color: #98fb98; font-weight: bold;">:cascade</span> <span style="color: #98fb98; font-weight: bold;">:cascade</span>))
   (fatal-weakness <span style="color: #98fb98; font-weight: bold;">:type</span> text <span style="color: #98fb98; font-weight: bold;">:default</span> <span style="color: #cd8162;">"None"</span>)
   (identifying-color <span style="color: #98fb98; font-weight: bold;">:type</span> (string 20) <span style="color: #98fb98; font-weight: bold;">:unique</span> t))
  (<span style="color: #98fb98; font-weight: bold;">:foreign-key</span> (identifying-color) (colors name))
  (<span style="color: #98fb98; font-weight: bold;">:constraint</span> enemy-age-check <span style="color: #98fb98; font-weight: bold;">:check</span> (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'age 12)))
</pre>
</div>
<p>
For more detail and examples on building tables
using the s-sql approach, see <a href="create-tables.html">create-tables.html</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgae5fa70" class="outline-3">
<h3 id="orgae5fa70"><a id="ID-936e7ced-7f31-4c94-9d39-81b11e2cd1cd"></a>sql-op :alter-table (name action &amp;rest args)</h3>
<div class="outline-text-3" id="text-orgae5fa70">
<p>
Alters named table. Currently changing a column's data type is not supported.
The meaning of args depends on action:
</p>

<ul class="org-ul">
<li>:add-column</li>
</ul>

<p>
Adds column to table. args should be a column in the same form as for :create-table.
</p>

<ul class="org-ul">
<li>:drop-column</li>
</ul>

<p>
Drops a column from the table.
</p>

<ul class="org-ul">
<li>:add-constraint</li>
</ul>

<p>
Adds a named constraint to the table.
</p>

<ul class="org-ul">
<li>:drop-constraint</li>
</ul>

<p>
Drops constraint. First of args should name a constraint to be dropped; second,
optional argument specifies behaviour regarding objects dependent on the
constraint and it may equal :cascade or :restrict.
</p>

<ul class="org-ul">
<li>:add</li>
</ul>

<p>
Adds an unnamed constraint to table. args should be a constraint in the same
form as for :create-table. (This is for backwards-compatibility, you should
use named constraints.)
</p>

<ul class="org-ul">
<li>:rename</li>
</ul>

<p>
Adds the ability to rename a table.
</p>

<ul class="org-ul">
<li>:rename-column</li>
</ul>

<p>
Adds the ability to rename a column of a table.
</p>

<p>
Here is an example using the table defined above:
</p>
<div class="org-src-container">
<pre class="src src-lsip">(query (alter-table enemy :drop-constraint enemy-age-check))

(query (:alter-table enemy :add-constraint enemy-age-check :check (:&gt; 'age 21)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org139f021" class="outline-3">
<h3 id="org139f021"><a id="ID-1f2b170f-09e2-40e6-9956-f3c44b1d2824"></a>sql-op :drop-table (name)</h3>
<div class="outline-text-3" id="text-org139f021">
<p>
Drops the named table. You may optionally pass :if-exists before the name
to suppress the error message. You can also optionally pass :cascade after
the name to indicate that it should also drop any other tables, indices,
etc which depend on that table.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:drop-table</span> 'table1))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-table</span> <span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'table1))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-table</span> <span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'table1 <span style="color: #98fb98; font-weight: bold;">:cascade</span>))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-table</span> (<span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'table1-with-longer-name) <span style="color: #98fb98; font-weight: bold;">:cascade</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgffa30e3" class="outline-3">
<h3 id="orgffa30e3"><a id="ID-f17b0128-f74e-4e79-90e4-d7cc97848c46"></a>sql-op :truncate (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgffa30e3">
<p>
Truncates one or more tables, deleting all the rows. Optional keyword arguments are
allowed in the following order. Note that :continue-identity and :restart-identity
make no sense if both are included.
</p>

<ul class="org-ul">
<li>:only (if not specified, the table and its descendants are truncated).</li>
<li>:continue-identity (the values of sequences will not be changed. This is the default)</li>
<li>:restart-identity (the values of sequences owned by the table(s) will be restarted)</li>
<li>:cascade (will cascade the truncation through tables using foreign keys.)</li>
</ul>

<p>
Example calls would be:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:truncate</span> 'bigtable 'fattable))

(query (<span style="color: #98fb98; font-weight: bold;">:truncate</span> 'bigtable 'fattable <span style="color: #98fb98; font-weight: bold;">:only</span>))

(query (<span style="color: #98fb98; font-weight: bold;">:truncate</span> 'bigtable 'fattable <span style="color: #98fb98; font-weight: bold;">:only</span> <span style="color: #98fb98; font-weight: bold;">:continue-identity</span>))

(query (<span style="color: #98fb98; font-weight: bold;">:truncate</span> 'bigtable 'fattable <span style="color: #98fb98; font-weight: bold;">:restart-identity</span>))

(query (<span style="color: #98fb98; font-weight: bold;">:truncate</span> 'bigtable 'fattable <span style="color: #98fb98; font-weight: bold;">:only</span> <span style="color: #98fb98; font-weight: bold;">:restart-identity</span> <span style="color: #98fb98; font-weight: bold;">:cascade</span> ))

</pre>
</div>
</div>
</div>

<div id="outline-container-org591caf5" class="outline-3">
<h3 id="org591caf5"><a id="ID-c06560b4-5dfb-4657-aa1f-dc3913fa08fc"></a>sql-op :create-index (name &amp;rest args)</h3>
<div class="outline-text-3" id="text-org591caf5">
<p>
Create an index on a table. After the name of the index the keyword :on should
follow, with the table name after it. Then the keyword :fields, followed by
one or more column names. Optionally, a :where clause with a condition can
be added at the end to make a partial index.
</p>

<div class="org-src-container">
<pre class="src src-lisp">(sql (<span style="color: #98fb98; font-weight: bold;">:create-index</span> 'gin-idx <span style="color: #98fb98; font-weight: bold;">:on</span> <span style="color: #cd8162;">"historical-events"</span> <span style="color: #98fb98; font-weight: bold;">:using</span> gin <span style="color: #98fb98; font-weight: bold;">:fields</span> 'data))

<span style="color: #cd8162;">"CREATE INDEX gin_idx ON historical_events USING GIN (data)"</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orgdf4af7b" class="outline-3">
<h3 id="orgdf4af7b"><a id="ID-b2f3a924-58c4-4c4e-9b08-603bb8f5bef3"></a>sql-op :create-unique-index (name &amp;rest args)</h3>
<div class="outline-text-3" id="text-orgdf4af7b">
<p>
Works like :create-index, except that the index created is unique.
</p>
</div>
</div>

<div id="outline-container-orgc6bd0c3" class="outline-3">
<h3 id="orgc6bd0c3"><a id="ID-e2c1e460-4d7b-449e-9b24-daa807f115b4"></a>sql-op :drop-index (name)</h3>
<div class="outline-text-3" id="text-orgc6bd0c3">
<p>
Drop an index. Takes :if-exists and/or :cascade arguments like :drop-table.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:drop-index</span> 'index1))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-index</span> <span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'index1))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-index</span> <span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'index1 <span style="color: #98fb98; font-weight: bold;">:cascade</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf27b599" class="outline-3">
<h3 id="orgf27b599"><a id="ID-6dad55a4-a0d4-4d94-923e-e34dd21417a0"></a>sql-op :create-sequence (name &amp;key increment min-value max-value start cache cycle)</h3>
<div class="outline-text-3" id="text-orgf27b599">
<p>
Create a sequence with the given name. The rest of the arguments control
the way the sequence selects values.
</p>
</div>
</div>

<div id="outline-container-org002c30c" class="outline-3">
<h3 id="org002c30c"><a id="ID-16b308a1-ae6c-4cac-816d-1e29b28ce0b9"></a>sql-op :alter-sequence (name)</h3>
<div class="outline-text-3" id="text-org002c30c">
<p>
Alters a sequence. See <a href="https://www.postgresql.org/docs/10/static/sql-altersequence.html">Postgresql documentation</a> for parameters.
</p>

<ul class="org-ul">
<li>:increment</li>
</ul>

<p>
Sets the amount by which each subsequent increment will be increased.
</p>

<ul class="org-ul">
<li>:min-value</li>

<li>:max-value</li>

<li>:no-min</li>

<li>:no-max</li>

<li>:start</li>

<li>:restart</li>

<li>:cache</li>

<li>:cycle</li>

<li>:no-cycle</li>

<li>:owned-by</li>

<li>:if-exists before the name to suppress the error message.</li>
</ul>
</div>
</div>

<div id="outline-container-org0f40b65" class="outline-3">
<h3 id="org0f40b65"><a id="ID-913c35f8-c6ba-42e3-a862-a46e313985ba"></a>sql-op :drop-sequence (name)</h3>
<div class="outline-text-3" id="text-org0f40b65">
<p>
Drop a sequence. Takes :if-exists and/or :cascade arguments like :drop-table.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:drop-sequence</span> 'sequence1))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-sequence</span> <span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'sequence1))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-sequence</span> <span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'sequence1 <span style="color: #98fb98; font-weight: bold;">:cascade</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org49639f7" class="outline-3">
<h3 id="org49639f7"><a id="ID-b5152a93-fc83-4e28-8678-2238987280ac"></a>sql-op :create-view (name query)</h3>
<div class="outline-text-3" id="text-org49639f7">
<p>
Create a view from an S-SQL-style query.
</p>
</div>
</div>

<div id="outline-container-orgf972b50" class="outline-3">
<h3 id="orgf972b50"><a id="ID-41ae2fb3-1d14-40a7-9cb3-eb194f90a692"></a>sql-op :drop-view (name)</h3>
<div class="outline-text-3" id="text-orgf972b50">
<p>
Drop a view. Takes optional :if-exists argument.
</p>
</div>
</div>

<div id="outline-container-org7e55719" class="outline-3">
<h3 id="org7e55719"><a id="ID-4e0e615b-cdb2-4576-a46d-20c25daf414a"></a>sql-op :set-constraints (state &amp;rest constraints)</h3>
<div class="outline-text-3" id="text-org7e55719">
<p>
Configure whether deferrable constraints should be checked when a statement
is executed, or when the transaction containing that statement is completed.
The provided state must be either :immediate, indicating the former,
or :deferred, indicating the latter. The constraints must be either the
names of the constraints to be configured, or unspecified, indicating that
all deferrable constraints should be thus configured.
</p>
</div>
</div>

<div id="outline-container-org9074391" class="outline-3">
<h3 id="org9074391"><a id="ID-254e8288-3515-4a51-8704-ea17c35f2c9b"></a>sql-op :listen (channel)</h3>
<div class="outline-text-3" id="text-org9074391">
<p>
Tell the server to listen for notification events on channel channel,
a string, on the current connection.
</p>
</div>
</div>

<div id="outline-container-org4c9614b" class="outline-3">
<h3 id="org4c9614b"><a id="ID-8899f2b4-8053-4e49-917f-8716c8ac916b"></a>sql-op :unlisten (channel)</h3>
<div class="outline-text-3" id="text-org4c9614b">
<p>
Stop listening for events on channel.
</p>
</div>
</div>

<div id="outline-container-org26de207" class="outline-3">
<h3 id="org26de207"><a id="ID-88d35022-2839-4ece-9688-c8517363e25a"></a>sql-op :notify (channel &amp;optional payload)</h3>
<div class="outline-text-3" id="text-org26de207">
<p>
Signal a notification event on channel channel, a string. The optional
payload string can be used to send additional event information to the listeners.
</p>
</div>
</div>

<div id="outline-container-org5d3c774" class="outline-3">
<h3 id="org5d3c774"><a id="ID-e4c5a84e-3a66-4a80-91de-b673beb8376d"></a>sql-op :create-role (role &amp;rest args)</h3>
<div class="outline-text-3" id="text-org5d3c774">
<p>
Create a new role (user). Following the role name are optional keywords
arguments:
</p>

<ul class="org-ul">
<li>:options</li>
</ul>

<p>
One or more of the no-parameter options to PostgreSQL's CREATE ROLE SQL command.
</p>

<ul class="org-ul">
<li>:password</li>
</ul>

<p>
Sets the role's password. (A password is only of use for roles having the LOGIN
attribute, but you can nonetheless define one for roles without it.) If you do
not plan to use password authentication you can omit this option. If no
password is specified, the password will be set to null and password
authentication will always fail for that user.
</p>

<ul class="org-ul">
<li>:connection-limit</li>
</ul>

<p>
If role can log in, this specifies how many concurrent connections the role can
make. -1 (the default) means no limit.
</p>

<ul class="org-ul">
<li>:valid-until</li>
</ul>

<p>
The :valid-until clause sets a date and time after which the role's password
is no longer valid. If this clause is omitted the password will be valid for
all time.
</p>

<ul class="org-ul">
<li>:role</li>
</ul>

<p>
Lists one or more existing roles which are automatically added as members of
the new role. (This in effect makes the new role a “group”.)
</p>

<ul class="org-ul">
<li>:in-role</li>
</ul>

<p>
Lists one or more existing roles to which the new role will be immediately
added as a new member.
</p>

<p>
Here is an example of a :create-role form:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:create-role</span> 'user23
                     <span style="color: #98fb98; font-weight: bold;">:options</span> 'SUPERUSER 'NOINHERIT 'LOGIN
                     <span style="color: #98fb98; font-weight: bold;">:password</span> <span style="color: #cd8162;">"mypassword"</span>
                     <span style="color: #98fb98; font-weight: bold;">:connection-limit</span> 100 <span style="color: #98fb98; font-weight: bold;">:role</span> 'users))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8c85a3" class="outline-3">
<h3 id="orgf8c85a3"><a id="ID-6d429954-eb91-4a94-8655-f1e1a75f02c8"></a>sql-op :create-database (name)</h3>
<div class="outline-text-3" id="text-orgf8c85a3">
<p>
Create a new database with the given name.
</p>
</div>
</div>

<div id="outline-container-orgcad2edd" class="outline-3">
<h3 id="orgcad2edd"><a id="ID-35ecfdd0-7ba1-45cc-a73d-68323c880c29"></a>sql-op :drop-database (name)</h3>
<div class="outline-text-3" id="text-orgcad2edd">
<p>
Drops the named database. You may optionally pass :if-exists before the
name to suppress the error message. Examples:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:drop-database</span> 'database-name))
(query (<span style="color: #98fb98; font-weight: bold;">:drop-database</span> <span style="color: #98fb98; font-weight: bold;">:if-exists</span> 'database-name))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf7dd2b4" class="outline-3">
<h3 id="orgf7dd2b4"><a id="ID-962e6b5e-8ce6-4083-a17e-010679d12b32"></a>sql-op :copy (table &amp;rest args)</h3>
<div class="outline-text-3" id="text-orgf7dd2b4">
<p>
Move data between Postgres tables and filesystem files. Table name is required
followed by one or more of the following keyword arguments. Documentation for
the copy command provides a full reference. An example from the Greenplum
tutorial:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query
   (<span style="color: #98fb98; font-weight: bold;">:copy</span> 'faa.d_airlines
    <span style="color: #98fb98; font-weight: bold;">:columns</span> 'airlineid 'airline_desc
    <span style="color: #98fb98; font-weight: bold;">:from</span> <span style="color: #cd8162;">"/home/gpadmin/gpdb-sandbox-tutorials/faa/L_AIRLINE_ID.csv"</span>
    <span style="color: #98fb98; font-weight: bold;">:on-segment</span> t
    <span style="color: #98fb98; font-weight: bold;">:binary</span> t
    <span style="color: #98fb98; font-weight: bold;">:oids</span> t
    <span style="color: #98fb98; font-weight: bold;">:header</span> t
    <span style="color: #98fb98; font-weight: bold;">:delimiter</span> <span style="color: #cd8162;">","</span>
    <span style="color: #98fb98; font-weight: bold;">:null</span> <span style="color: #cd8162;">"NULL"</span>
    <span style="color: #98fb98; font-weight: bold;">:escape</span> <span style="color: #cd8162;">"my-escape-string"</span>
    <span style="color: #98fb98; font-weight: bold;">:newline</span> <span style="color: #cd8162;">"CR"</span>
    <span style="color: #98fb98; font-weight: bold;">:csv</span> t
    <span style="color: #98fb98; font-weight: bold;">:log-errors</span> t
    <span style="color: #98fb98; font-weight: bold;">:segment-reject-limit</span> 100 'ROWS))

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3df0b82" class="outline-2">
<h2 id="dynamic-queries-composition-and-parameterized-queries"><a id="org3df0b82"></a><a id="ID-d621dc4b-5ae1-408a-be3c-c553dcd5d9a6"></a>Dynamic Queries, Composition and Parameterized Queries</h2>
<div class="outline-text-2" id="text-dynamic-queries-composition-and-parameterized-queries">
</div>

<div id="outline-container-org607b420" class="outline-3">
<h3 id="overview"><a id="org607b420"></a><a id="ID-56999390-1d72-4ae1-bea6-1f3a5eeb08f7"></a>Overview</h3>
<div class="outline-text-3" id="text-overview">
<p>
The question gets asked how to build dynamic or composable queries in
postmodern. First we need to understand the context - is the programmer
building the query or are you taking data from a user and using that to
build a query?
</p>
</div>

<div id="outline-container-orgec6a6d0" class="outline-4">
<h4 id="programmer-built-queries"><a id="orgec6a6d0"></a><a id="ID-17b9050a-026f-4552-93b3-e08cb9ba5851"></a>Programmer Built Queries</h4>
<div class="outline-text-4" id="text-programmer-built-queries">
<p>
If you are not using s-sql, then it becomes easy. The query macro
assumes that everything that is not a list starting with a keyword will
evaluate to a string. That means you can build it with a simple format
string
</p>

<pre class="example">
(query (format nil "select ~a from ~a where ~a"  "carrots" "garden" "length &gt; 3"))
</pre>

<p>
With s-sql, there are generally two approaches to building dynamic or
composible queries: either use sql-compile or use :raw.
</p>

<p>
For purposes of this example, we will use the following employee table:
</p>

<pre class="example">
(query (:create-table employee ((id :type int)
                                (name :type text)
                                (salary :type numeric)
                                (start_date :type date)
                                (city :type text)
                                (region :type char)
                                (age :type int))))

(query (:insert-rows-into 'employee
                          :columns 'id 'name 'salary 'start-date 'city 'region 'age
                          :values '((1 "Jason" 40420 "02/01/94" "New York" "W" 29)
                                    (2 "Robert" 14420 "01/02/95" "Vancouver" "N" 21)
                                    (3 "Celia" 24020 "12/03/96" "Toronto" "W" 24)
                                    (4 "Linda" 40620 "11/04/97" "New York" "N" 28)
                                    (5 "David" 80026 "10/05/98" "Vancouver" "W" 31)
                                    (6 "James" 70060 "09/06/99" "Toronto" "N" 26)
                                    (7 "Alison" 90620 "08/07/00" "New York" "W" 38)
                                    (8 "Chris" 26020 "07/08/01" "Vancouver" "N" 22)
                                    (9 "Mary" 60020 "06/08/02" "Toronto" "W" 34))))
</pre>

<ol class="org-ol">
<li>Approach #1 Use sql-compile</li>
</ol>

<p>
Sql-compile does a run-time compilation of an s-sql expression. In the
following example, we create a function that accepts a where-clause, a
table-name, 3 columns to select and two parameters to go into the where
clause.
</p>

<pre class="example">
(defun toy-example (where-clause table-name col1 col2 col3 arg1 arg2)
       (with-test-connection
       (query (sql-compile
                (append `(:select ,col1 ,col2 ,col3 :from ,table-name :where)
                       where-clause))
              arg1 arg2)))

    (toy-example '((:and (:= 'city '$1) (:&gt; 'salary '$2))) 'employee 'id 'name 'city "Toronto" 45000)

    ((6 "James" "Toronto") (9 "Mary" "Toronto"))
</pre>

<p>
If we just look at what this call to sql-compile in toy-example
generates, it would look like:
</p>

<pre class="example">
"(SELECT id, name, city FROM employee WHERE ((city = $1) and (salary &gt; $2)))"
</pre>

<p>
This example is still a parameterized query but for security reasons you
will need to be very careful how you generate the where clause.
</p>

<p>
Another example with sql-compile and append, in this case updating a
table and setting two columns to NULL.
</p>

<pre class="example">
(sql-compile (append '(:update :table1 :set)
                     (loop for a in '("col1" "col2")
                           collect a
                           collect :NULL)))

"UPDATE table1 SET E'col1' = NULL, E'col2' = NULL"
</pre>

<p>
Lets think about it differently. What if we know the universe of columns
we want to select, but want to conditionally select some of them.
Suppose we know our targetted table has columns:
</p>

<pre class="example">
'id 'name 'salary 'start-date 'city 'region 'age.
</pre>

<p>
We may decide we always want name, city and age, but salary and
start-date are conditional.
</p>

<pre class="example">
(defun toy-example-2 (salaryp start-date-p)
  (sql-compile
   (remove nil `(:select 'name 'city 'age
                         ,(if salaryp 'salary nil)
                         ,(if start-date-p 'start-date nil)
                         :from 'employee))))

(query (toy-example-2 t t))

(("Jason" "New York" 29 40420 #&lt;SIMPLE-DATE:DATE 01-02-1994&gt;)
 ("Robert" "Vancouver" 21 14420 #&lt;SIMPLE-DATE:DATE 02-01-1995&gt;)
 ("Celia" "Toronto" 24 24020 #&lt;SIMPLE-DATE:DATE 03-12-1996&gt;)
 ("Linda" "New York" 28 40620 #&lt;SIMPLE-DATE:DATE 04-11-1997&gt;)
 ("David" "Vancouver" 31 80026 #&lt;SIMPLE-DATE:DATE 05-10-1998&gt;)
 ("James" "Toronto" 26 70060 #&lt;SIMPLE-DATE:DATE 06-09-1999&gt;)
 ("Alison" "New York" 38 90620 #&lt;SIMPLE-DATE:DATE 07-08-2000&gt;)
 ("Chris" "Vancouver" 22 26020 #&lt;SIMPLE-DATE:DATE 08-07-2001&gt;)
 ("Mary" "Toronto" 34 60020 #&lt;SIMPLE-DATE:DATE 08-06-2002&gt;))

(query (toy-example-2 t nil))

(("Jason" "New York" 29 40420) ("Robert" "Vancouver" 21 14420)
 ("Celia" "Toronto" 24 24020) ("Linda" "New York" 28 40620)
 ("David" "Vancouver" 31 80026) ("James" "Toronto" 26 70060)
 ("Alison" "New York" 38 90620) ("Chris" "Vancouver" 22 26020)
 ("Mary" "Toronto" 34 60020))
</pre>

<p>
You could skip the (remove nil&#x2026; portion and substitute t for nil. E.g.
</p>

<pre class="example">
(defun toy-example-2 (salaryp start-date-p)
  (sql-compile
   `(:select 'name 'city 'age
             ,(if salaryp 'salary t)
             ,(if start-date-p 'start-date t)
             :from 'employee)))
</pre>

<p>
But I prefer to remove those segments completely from the query.
</p>

<p>
Following on this same thread of thought, you can define a portion of
the sql in a let clause:
</p>

<pre class="example">
(let ((sql1 '(:= name "Jason")))
  (query (sql-compile
    `(:select 'name 'city 'age :from 'employee :where ,sql1))))

(("Jason" "New York" 29))
</pre>

<p>
An example of this would be getting more columns depending on the
postgresql server versionr:
</p>

<pre class="example">
(defun more-table-info (table-name)
  "Returns variable amounts of information depending on the postgresql server version"
  (let* ((version&gt;11 (postgresql-version-at-least "12.0" *database*))
         (version&gt;10 (postgresql-version-at-least "11.0" *database*))
         (select-query (sql-compile
                        `(:order-by
                          (:select (:as 'a.attnum 'ordinal-position)
                                   (:as 'a.attname 'column-name)
                                   (:as 'tn.typname 'data-type)
                                   ,(if version&gt;10 'a.attidentity t)
                                   ,(if version&gt;11 'a.attgenerated t)
                                   :from (:as 'pg_class 'c)
                                   (:as 'pg_attribute 'a)
                                   (:as 'pg_type 'tn)
                                   :where (:and
                                           (:= 'c.relname '$1)
                                           (:&gt; 'a.attnum 0)
                                           (:= 'a.attrelid 'c.oid)
                                           (:= 'a.atttypid 'tn.oid)))
                          'a.attnum))))
    (query select-query
           (to-sql-name table-name))))
</pre>

<ol class="org-ol">
<li>Approach #2 Use :raw</li>
</ol>

<p>
To quote Marijn, the :raw keyword takes a string and inserts it straight
into the query. I try to stay away from :raw if possible, but
sometimes&#x2026;
</p>

<pre class="example">
(query (:select (:raw "tmp1.name") :from (:as 'baz (:raw "tmp1"))))
</pre>
</div>
</div>

<div id="outline-container-orga2f6925" class="outline-4">
<h4 id="queries-with-user-input"><a id="orga2f6925"></a><a id="ID-db5db32e-31b5-424e-8cb8-97bb88029515"></a>Queries with User Input</h4>
<div class="outline-text-4" id="text-queries-with-user-input">
<p>
In any of the above approaches to building queries you will need to
ensure that either you have control over the inputs or they still result
in parameterized queries. If not you have opened yourself up to an sql
injection attack.
</p>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
